<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ®µä½TJA åˆ†å‰²ï¼†å†ç”Ÿç”¨ä¿®æ­£ãƒ„ãƒ¼ãƒ«</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --bg-color: #1e1e1e;
            --card-bg: #2d2d2d;
            --accent: #4caf50;
            --text-main: #e0e0e0;
            --text-sub: #b0b0b0;
            --log-bg: #121212;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            width: 100%;
            max-width: 800px;
            background: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
        }
        h1 {
            color: var(--accent);
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8rem;
            border-bottom: 2px solid #333;
            padding-bottom: 15px;
        }
        .desc {
            margin-bottom: 20px;
            color: var(--text-sub);
            line-height: 1.6;
            font-size: 0.95rem;
        }
        .upload-box {
            border: 2px dashed #555;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #333;
        }
        .upload-box:hover {
            border-color: var(--accent);
            background: #3a3a3a;
        }
        .upload-box p {
            margin: 0;
            font-size: 1.1rem;
            color: #aaa;
        }
        .btn-area {
            margin-top: 25px;
        }
        button {
            width: 100%;
            padding: 15px;
            background-color: var(--accent);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
            opacity: 0.5;
            pointer-events: none;
        }
        button.active {
            opacity: 1;
            pointer-events: auto;
        }
        button:hover {
            background-color: #43a047;
            transform: translateY(-2px);
        }
        #log {
            margin-top: 20px;
            background: var(--log-bg);
            padding: 15px;
            border-radius: 6px;
            height: 300px;
            overflow-y: auto;
            font-family: Consolas, monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            border: 1px solid #333;
        }
        .log-info { color: #81d4fa; }
        .log-success { color: #a5d6a7; }
        .log-warn { color: #fff59d; }
        .log-err { color: #ef9a9a; }
        .log-fix { color: #ce93d8; font-weight: bold; } /* ä¿®æ­£ç®‡æ‰€ã®å¼·èª¿ */
    </style>
</head>
<body>

<div class="container">
    <h1>æ®µä½TJA åˆ†å‰²ãƒ»ä¿®æ­£ãƒ„ãƒ¼ãƒ«</h1>
    <div class="desc">
        <p>æ®µä½é“å ´ã®TJAãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€é€šå¸¸ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã§å†ç”Ÿå¯èƒ½ãªå½¢å¼ã«å¤‰æ›ãƒ»åˆ†å‰²ã—ã¾ã™ã€‚</p>
        <ul>
            <li>#START / #END ã®è‡ªå‹•ä»˜ä¸</li>
            <li>#DELAY (å¾…æ©Ÿå‘½ä»¤) ã®å‰Šé™¤</li>
            <li>BALLOON / KUSUDAMA ã®æ­£ç¢ºãªå†åˆ†é…</li>
        </ul>
    </div>

    <div class="upload-box" id="dropZone" onclick="document.getElementById('fileInput').click()">
        <p>ğŸ“‚ ã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ<br><span style="font-size:0.8rem">(ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—)</span></p>
        <input type="file" id="fileInput" webkitdirectory directory multiple style="display:none">
    </div>
    <div id="file-status" style="text-align:center; margin-top:10px; font-weight:bold; color:var(--accent);"></div>

    <div class="btn-area">
        <button id="runBtn">å¤‰æ›ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
    </div>

    <div id="log">ãƒ­ã‚°å¾…æ©Ÿä¸­...</div>
</div>

<script>
    // --- å¤‰æ•°å®šç¾© ---
    const fileInput = document.getElementById('fileInput');
    const dropZone = document.getElementById('dropZone');
    const runBtn = document.getElementById('runBtn');
    const logArea = document.getElementById('log');
    const fileStatus = document.getElementById('file-status');

    let targetTjaFile = null;
    let fileMap = new Map(); // éŸ³æºãƒ•ã‚¡ã‚¤ãƒ«ä¿æŒç”¨

    // --- ãƒ­ã‚®ãƒ³ã‚°é–¢æ•° ---
    function log(msg, type = 'info') {
        const div = document.createElement('div');
        div.textContent = msg;
        div.className = `log-${type}`;
        logArea.appendChild(div);
        logArea.scrollTop = logArea.scrollHeight;
    }

    // --- ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›å‡¦ç† ---
    fileInput.addEventListener('change', e => handleFiles(e.target.files));
    dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.style.borderColor = '#4caf50'; });
    dropZone.addEventListener('dragleave', e => { e.preventDefault(); dropZone.style.borderColor = '#555'; });
    dropZone.addEventListener('drop', e => {
        e.preventDefault();
        dropZone.style.borderColor = '#555';
        handleFiles(e.dataTransfer.files);
    });

    function handleFiles(files) {
        fileMap.clear();
        targetTjaFile = null;
        logArea.innerHTML = '';
        fileStatus.textContent = '';
        runBtn.classList.remove('active');

        const fileList = Array.from(files);
        if (fileList.length === 0) return;

        let tjaCount = 0;
        fileList.forEach(f => {
            fileMap.set(f.name, f);
            if (f.name.toLowerCase().endsWith('.tja')) {
                targetTjaFile = f;
                tjaCount++;
            }
        });

        if (targetTjaFile) {
            fileStatus.textContent = `èª­è¾¼: ${targetTjaFile.name} (ä»– ${fileList.length - 1} ãƒ•ã‚¡ã‚¤ãƒ«)`;
            log(`[æº–å‚™] ã‚¿ãƒ¼ã‚²ãƒƒãƒˆTJA: ${targetTjaFile.name}`, 'info');
            if(tjaCount > 1) log(`[æ³¨æ„] è¤‡æ•°ã®TJAãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚${targetTjaFile.name} ã‚’å‡¦ç†ã—ã¾ã™ã€‚`, 'warn');
            runBtn.classList.add('active');
        } else {
            log('[ã‚¨ãƒ©ãƒ¼] TJAãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'err');
        }
    }

    // --- ãƒ¡ã‚¤ãƒ³å‡¦ç†å®Ÿè¡Œ ---
    runBtn.addEventListener('click', async () => {
        if (!targetTjaFile) return;
        runBtn.textContent = "å‡¦ç†ä¸­...";
        runBtn.classList.remove('active');

        try {
            await processTja();
            runBtn.textContent = "å®Œäº†ï¼";
        } catch (e) {
            console.error(e);
            log(`[è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼] ${e.message}`, 'err');
            runBtn.textContent = "ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ";
        }
        
        setTimeout(() => {
            runBtn.classList.add('active');
            runBtn.textContent = "å¤‰æ›ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰";
        }, 3000);
    });

    // --- TJAè§£æãƒ»å¤‰æ›ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯ ---
    async function processTja() {
        const zip = new JSZip();
        
        // 1. ãƒ•ã‚¡ã‚¤ãƒ«èª­è¾¼ (SJIS or UTF8)
        let text = await readFileContent(targetTjaFile);
        const lines = text.split(/\r?\n/);

        // 2. BALLOONå…¨å–å¾—
        let globalBalloons = [];
        let tempBalloonStr = "";
        lines.forEach(l => {
            if (l.trim().toUpperCase().startsWith('BALLOON:')) {
                tempBalloonStr += l.trim().substring(8) + ",";
            }
        });
        if (tempBalloonStr) {
            globalBalloons = tempBalloonStr.split(/[,ã€\s]+/)
                .map(n => parseInt(n))
                .filter(n => !isNaN(n));
            log(`[å…¨ä½“] é¢¨èˆ¹ãƒ—ãƒ¼ãƒ«: åˆè¨ˆ ${globalBalloons.length} å€‹ã‚’æ¤œå‡º`, 'info');
        }

        // 3. ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ†å‰²
        let sections = [];
        let buffer = [];
        let nextTag = ""; // #NEXTSONG ...

        // æœ€åˆã®è¡Œã®BOMå¯¾ç­–
        if(lines.length > 0 && lines[0].charCodeAt(0) === 0xFEFF) lines[0] = lines[0].substr(1);

        for (let line of lines) {
            if (line.trim().toUpperCase().startsWith('#NEXTSONG')) {
                sections.push({ lines: buffer, tag: nextTag });
                buffer = [];
                nextTag = line.trim();
            } else {
                buffer.push(line);
            }
        }
        sections.push({ lines: buffer, tag: nextTag }); // æœ€å¾Œã®æ›²

        // 4. å„æ›²ã®å‡¦ç†
        let balloonCursor = 0;
        let currentBpm = 0; // æ›²ã‚’ã¾ãŸã„ã§ç¶­æŒã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹ãŸã‚

        // 0ç•ªç›®ã¯è¡¨ç´™(Intro)ãªã®ã§ã€é¢¨èˆ¹æ¶ˆè²»ã ã‘ãƒã‚§ãƒƒã‚¯ã—ã¦å‡ºåŠ›ã—ãªã„
        if (sections.length > 0) {
            const intro = sections[0];
            // BPMå–å¾—
            intro.lines.forEach(l => {
                if (l.trim().toUpperCase().startsWith('BPM:')) currentBpm = parseFloat(l.split(':')[1]);
            });
            const introUsed = count79(intro.lines);
            if(introUsed > 0) {
                balloonCursor += introUsed;
                log(`[Intro] è¡¨ç´™éƒ¨åˆ†ã§é¢¨èˆ¹ ${introUsed} å€‹ã‚’ã‚¹ã‚­ãƒƒãƒ—`, 'warn');
            }
        }

        // 1ç•ªç›®ä»¥é™ (å®Ÿéš›ã®æ›²)
        for (let i = 1; i < sections.length; i++) {
            const section = sections[i];
            const args = parseNextSongArgs(section.tag);
            
            // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾—
            const title = args[0] || `Song_${i}`;
            const subTitle = args[1] || "";
            const genre = args[2] || "";
            const wave = args[3] || "";
            const scoreInit = args[4] || "";
            const scoreDiff = args[5] || "";
            
            // é›£æ˜“åº¦åˆ¤å®š (ç°¡æ˜“)
            let course = "Oni"; 
            let level = "10";
            if (args.length >= 8) {
                if (parseFloat(args[6]) > 4) { level = args[6]; course = mapCourse(args[7]); }
                else { course = mapCourse(args[6]); level = args[7]; }
            } else {
                // å¼•æ•°ãŒè¶³ã‚Šãªã„å ´åˆã¯å‰ã®æ–¹ã®å¼•æ•°ã§æ¨æ¸¬
                if(args[6]) level = args[6];
            }

            // --- é¢¨èˆ¹åˆ†é… ---
            const needed = count79(section.lines);
            let myBalloons = [];
            for(let k=0; k<needed; k++) {
                if(balloonCursor < globalBalloons.length) {
                    myBalloons.push(globalBalloons[balloonCursor]);
                    balloonCursor++;
                } else {
                    myBalloons.push(5); // ä¸è¶³æ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
                    log(`[${title}] é¢¨èˆ¹ä¸è¶³: 5ã‚’è£œå¡«`, 'warn');
                }
            }
            if(needed > 0) log(`[${title}] é¢¨èˆ¹å‰²å½“: ${needed}å€‹ [${myBalloons.join(',')}]`, 'success');

            // --- è­œé¢ãƒ‡ãƒ¼ã‚¿ã®ä¿®æ­£ (Sanitize) ---
            let bodyLines = [];
            let removedDelay = false;
            
            section.lines.forEach(l => {
                const t = l.trim().toUpperCase();
                // ä¸è¦ãªã‚³ãƒãƒ³ãƒ‰ã®å‰Šé™¤
                if (t.startsWith('#DELAY')) {
                    removedDelay = true;
                    return; // å‰Šé™¤
                }
                if (t.startsWith('#START') || t.startsWith('#END')) return; // å¾Œã§ä»˜ã‘ç›´ã™ã®ã§å‰Šé™¤
                if (t.startsWith('BALLOON:')) return; // å€‹åˆ¥ã«æ›¸ãç›´ã™ã®ã§å‰Šé™¤
                
                // BPMè¿½è·¡
                if (t.startsWith('#BPMCHANGE')) {
                    const parts = l.trim().split(/\s+/);
                    if (parts[1]) currentBpm = parseFloat(parts[1]);
                }
                
                bodyLines.push(l);
            });

            if(removedDelay) log(`[${title}] ä¿®æ­£: #DELAY ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`, 'fix');

            // --- å‡ºåŠ›ç”¨TJAæ§‹ç¯‰ ---
            let outLines = [];
            outLines.push(`TITLE:${title}`);
            if(subTitle) outLines.push(`SUBTITLE:${subTitle}`);
            outLines.push(`BPM:${currentBpm}`); // æœ€æ–°ã®BPMã‚’ã‚»ãƒƒãƒˆ
            outLines.push(`WAVE:${wave}`);
            outLines.push(`OFFSET:0`); // å˜æ›²åŒ–ã™ã‚‹ã®ã§Offsetã¯0åŸºæº–(å¿…è¦ãªã‚‰æ‰‹å‹•èª¿æ•´)
            outLines.push(`GENRE:${genre}`);
            outLines.push(`COURSE:${course}`);
            outLines.push(`LEVEL:${level}`);
            outLines.push(`BALLOON:${myBalloons.join(',')}`);
            outLines.push(`SCOREINIT:${scoreInit}`);
            outLines.push(`SCOREDIFF:${scoreDiff}`);
            outLines.push(`SCOREMODE:2`); // æ®µä½ã¯åŸºæœ¬çš„ã«2
            outLines.push('');
            
            // å¼·åˆ¶çš„ã« #START / #END ã§å›²ã‚€
            outLines.push('#START');
            outLines = outLines.concat(bodyLines);
            // æœ€å¾Œã®è¡ŒãŒç©ºè¡Œã§ãªã‘ã‚Œã°è¿½åŠ 
            if (outLines[outLines.length-1].trim() !== "") outLines.push("");
            outLines.push('#END');

            // --- ZIPã«è¿½åŠ  ---
            const safeTitle = title.replace(/[\\/:*?"<>|]/g, "_");
            const folderName = `${i}_${safeTitle}`;
            const folder = zip.folder(folderName);
            
            // TJAæ›¸ãå‡ºã—
            folder.file(`${safeTitle}.tja`, outLines.join('\r\n'));
            
            // éŸ³æºã‚³ãƒ”ãƒ¼
            if (wave) {
                // ãƒ‘ã‚¹ãŒå«ã¾ã‚Œã‚‹å ´åˆãŒã‚ã‚‹ã®ã§ãƒ•ã‚¡ã‚¤ãƒ«åã ã‘æŠ½å‡º
                const waveFileName = wave.split(/[/\\]/).pop();
                if (fileMap.has(waveFileName)) {
                    folder.file(waveFileName, fileMap.get(waveFileName));
                    log(`[${title}] éŸ³æºåŒæ¢±: ${waveFileName}`, 'success');
                } else {
                    log(`[${title}] éŸ³æºæœªæ¤œå‡º: ${waveFileName}`, 'warn');
                }
            }
        }

        // 5. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ
        const content = await zip.generateAsync({type:"blob"});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(content);
        link.download = targetTjaFile.name.replace(/\.tja$/i, "") + "_fixed_split.zip";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        log("ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼", 'info');
    }

    // --- è£œåŠ©é–¢æ•°: å¼·åŠ›ã‚«ã‚¦ãƒ³ãƒˆ (å‘½ä»¤æ–‡ãªã©ã‚’ç„¡è¦–ã—ã¦7/9ã‚’æ•°ãˆã‚‹) ---
    function count79(lines) {
        let count = 0;
        for (let line of lines) {
            let trim = line.trim();
            if (!trim) continue;
            
            // ã‚³ãƒ¡ãƒ³ãƒˆé™¤å»
            let code = trim.split('//')[0].trim();
            if (!code) continue;
            
            // ãƒ˜ãƒƒãƒ€(TITLE:)ã‚„å‘½ä»¤(#BPM)ã¯é™¤å¤–
            if (code.includes(':') || code.startsWith('#')) continue;
            
            // æ–‡å­—åˆ—ä¸­ã® 7, 9 ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            for (let char of code) {
                if (char === '7' || char === '9') count++;
            }
        }
        return count;
    }

    // --- è£œåŠ©é–¢æ•°: ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ (æ–‡å­—ã‚³ãƒ¼ãƒ‰è‡ªå‹•åˆ¤åˆ¥ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯) ---
    function readFileContent(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const buffer = e.target.result;
                // ã¾ãšShift-JISã¨ã—ã¦ãƒ‡ã‚³ãƒ¼ãƒ‰ã‚’è©¦ã¿ã‚‹
                const decoderSJIS = new TextDecoder('shift-jis');
                const textSJIS = decoderSJIS.decode(buffer);
                
                // æ˜ã‚‰ã‹ã«UTF-8ã£ã½ã„ç‰¹å¾´ï¼ˆTITLEãªã©ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã€æ–‡å­—åŒ–ã‘ï¼‰ãŒã‚ã‚‹ã‹ç°¡æ˜“ãƒã‚§ãƒƒã‚¯
                // æ®µä½ãƒ•ã‚¡ã‚¤ãƒ«ã¯ "TITLE:" ã‹ "#NEXTSONG" ãŒå¿…ãšã‚ã‚‹ã¯ãš
                if (textSJIS.includes('TITLE:') || textSJIS.includes('#NEXTSONG') || textSJIS.includes('COURSE:')) {
                    resolve(textSJIS);
                } else {
                    // UTF-8ã§å†ãƒˆãƒ©ã‚¤
                    const decoderUTF8 = new TextDecoder('utf-8');
                    resolve(decoderUTF8.decode(buffer));
                }
            };
            reader.onerror = reject;
            reader.readAsArrayBuffer(file);
        });
    }

    // --- è£œåŠ©é–¢æ•°: å¼•æ•°ãƒ‘ãƒ¼ã‚¹ ---
    function parseNextSongArgs(tag) {
        // ä¾‹: #NEXTSONG Title, Sub, Genre, Wave, ScoreInit, ScoreDiff, Level, Course
        const raw = tag.replace(/^#NEXTSONG\s+/i, '');
        return raw.split(',').map(s => s.trim());
    }

    function mapCourse(val) {
        const map = ["Easy", "Normal", "Hard", "Oni", "Edit"];
        const idx = parseInt(val);
        return map[idx] || "Oni";
    }

</script>
</body>
</html>
