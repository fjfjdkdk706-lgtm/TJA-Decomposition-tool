<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>æ®µä½TJAåˆ†å‰²ãƒ„ãƒ¼ãƒ« (é¢¨èˆ¹å‰²ã‚Šå½“ã¦å³æ ¼ç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body { font-family: "Helvetica Neue", sans-serif; background: #eceff1; padding: 20px; display: flex; justify-content: center; }
        .card { background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 800px; }
        h1 { margin-top: 0; color: #37474f; border-bottom: 2px solid #cfd8dc; padding-bottom: 15px; font-size: 1.5rem; }
        .upload-box { border: 3px dashed #b0bec5; padding: 30px; text-align: center; margin-bottom: 20px; border-radius: 8px; background: #f9fafb; cursor: pointer; transition: 0.2s; }
        .upload-box:hover { background: #e3f2fd; border-color: #2196f3; }
        
        button { width: 100%; padding: 15px; background: #009688; color: white; font-weight: bold; border: none; border-radius: 6px; cursor: pointer; font-size: 1.1rem; opacity: 0.6; pointer-events: none; transition: 0.2s; }
        button.active { opacity: 1; pointer-events: auto; }
        button:hover { background: #00796b; }

        #console { margin-top: 20px; background: #263238; color: #cfd8dc; padding: 15px; height: 350px; overflow-y: scroll; font-family: "Consolas", monospace; font-size: 0.9rem; border-radius: 5px; white-space: pre-wrap; line-height: 1.4; }
        
        .log-info { color: #81d4fa; }
        .log-success { color: #69f0ae; font-weight: bold; }
        .log-warn { color: #ffd740; }
        .log-error { color: #ff5252; font-weight: bold; }
        .highlight { color: #ffffff; background: #37474f; padding: 0 4px; border-radius: 3px; }
    </style>
</head>
<body>

<div class="card">
    <h1>æ®µä½TJA åˆ†å‰²ãƒ»ç”Ÿæˆãƒ„ãƒ¼ãƒ« (BALLOONé€£æºç¢ºèªç‰ˆ)</h1>
    <p style="color:#666; font-size:0.9rem;">7(é¢¨èˆ¹)ã¨9(ãã™ç‰)ã®ã‚«ã‚¦ãƒ³ãƒˆæ•°ã¨ã€BALLOONå®šç¾©ã‹ã‚‰ã®å‰²ã‚Šå½“ã¦çŠ¶æ³ã‚’ãƒ­ã‚°ã§å®Œå…¨ã«å¯è¦–åŒ–ã—ã¾ã™ã€‚</p>
    
    <div class="upload-box" onclick="document.getElementById('fileInput').click()">
        <p>ğŸ“‚ ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ (ã‚¯ãƒªãƒƒã‚¯)</p>
        <input type="file" id="fileInput" webkitdirectory directory multiple style="display:none">
        <div id="file-name" style="font-weight:bold; color:#455a64; margin-top:10px;">æœªé¸æŠ</div>
    </div>

    <button id="execBtn">å®Ÿè¡Œãƒ»ZIPä½œæˆ</button>
    <div id="console">å¾…æ©Ÿä¸­...</div>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const fileNameDiv = document.getElementById('file-name');
    const execBtn = document.getElementById('execBtn');
    const logDiv = document.getElementById('console');

    let targetTja = null;
    let fileMap = new Map();

    function log(msg, type='info') {
        const div = document.createElement('div');
        div.innerHTML = msg; // allow HTML tags
        div.className = `log-${type}`;
        logDiv.appendChild(div);
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    fileInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        fileMap.clear();
        targetTja = null;
        logDiv.innerHTML = '';

        if(files.length === 0) return;

        files.forEach(f => {
            fileMap.set(f.name, f);
            if(f.name.toLowerCase().endsWith('.tja')) targetTja = f;
        });

        if(targetTja) {
            fileNameDiv.textContent = `è§£æå¯¾è±¡: ${targetTja.name}`;
            log(`[æº–å‚™] TJAãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç™ºè¦‹: ${targetTja.name}`, 'success');
            execBtn.classList.add('active');
        } else {
            fileNameDiv.textContent = "ã‚¨ãƒ©ãƒ¼: .tjaãƒ•ã‚¡ã‚¤ãƒ«ãªã—";
            log("[ã‚¨ãƒ©ãƒ¼] ãƒ•ã‚©ãƒ«ãƒ€å†…ã« .tja ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚", 'error');
        }
    });

    execBtn.addEventListener('click', async () => {
        if(!targetTja) return;
        execBtn.disabled = true;
        execBtn.textContent = "å‡¦ç†ä¸­...";
        
        try {
            await processTja();
            execBtn.textContent = "å®Œäº†ï¼";
        } catch(err) {
            console.error(err);
            log(`[è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼] ${err.message}`, 'error');
            execBtn.textContent = "ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ";
        }
        
        setTimeout(() => {
            execBtn.disabled = false;
            execBtn.textContent = "å®Ÿè¡Œãƒ»ZIPä½œæˆ";
        }, 3000);
    });

    async function processTja() {
        // 1. èª­ã¿è¾¼ã¿
        let text = await readFile(targetTja, 'shift-jis');
        if(!text.includes('TITLE:') && !text.includes('#NEXTSONG')) {
            log("[å†è©¦è¡Œ] UTF-8ã§èª­ã¿ç›´ã—ã¾ã™...", 'warn');
            text = await readFile(targetTja, 'utf-8');
        }
        
        const lines = text.split(/\r?\n/);
        const zip = new JSZip();

        // 2. BALLOONå®šç¾©ã®æŠ½å‡º (å…¨è¡Œèµ°æŸ»)
        let globalBalloons = [];
        let rawBalloonStr = "";

        // è¡Œã‚’ã¾ãŸãè¨˜è¿°ã«ã‚‚å¯¾å¿œã™ã‚‹ãŸã‚ã€ä¸€åº¦BALLOON:ã‚’è¦‹ã¤ã‘ãŸã‚‰æ–‡å­—åˆ—ã‚’çµåˆã™ã‚‹
        for(let line of lines) {
            let t = line.trim();
            if(t.toUpperCase().startsWith('BALLOON:')) {
                let val = t.substring(8).trim();
                // ç°¡æ˜“çš„ãªå‡¦ç†: è¡Œæœ«ã¾ã§ã®æ•°å­—ã‚’å–å¾—
                if(val) rawBalloonStr += val + ",";
            }
        }
        
        // é…åˆ—åŒ–
        if(rawBalloonStr) {
            globalBalloons = rawBalloonStr.split(/[,ã€\s]+/)
                .map(n => parseInt(n))
                .filter(n => !isNaN(n));
            log(`[å…¨ä½“å®šç¾©] BALLOONæ•°å€¤ã‚’ç¢ºä¿: <span class="highlight">${globalBalloons.length}å€‹</span>`, 'success');
            // log(`ãƒ‡ãƒ¼ã‚¿: [${globalBalloons.join(', ')}]`, 'info');
        } else {
            log(`[è­¦å‘Š] BALLOON:å®šç¾©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å…¨ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤(5)ã«ãªã‚Šã¾ã™ã€‚`, 'warn');
        }

        // 3. æ›²ã”ã¨ã®ãƒ–ãƒ­ãƒƒã‚¯åˆ†å‰²
        let songs = [];
        let buffer = [];
        let nextTag = "";

        for(let line of lines) {
            if(line.charCodeAt(0)===0xFEFF) line = line.substr(1);
            let trim = line.trim();
            
            if(trim.toUpperCase().startsWith('#NEXTSONG')) {
                songs.push({ lines: buffer, tag: nextTag });
                buffer = [];
                nextTag = trim;
            } else {
                buffer.push(line);
            }
        }
        songs.push({ lines: buffer, tag: nextTag }); // Last one

        // 4. è§£æã¨å‰²ã‚Šå½“ã¦ (ã“ã“ãŒæ ¸å¿ƒ)
        let balloonCursor = 0;
        let currentBpm = 0;
        let processed = 0;

        // --- 0æ›²ç›® (Intro) ---
        if(songs.length > 0) {
            const intro = songs[0];
            // BPMå–å¾—
            intro.lines.forEach(l => {
                if(l.trim().toUpperCase().startsWith('BPM:')) currentBpm = parseFloat(l.split(':')[1]);
            });
            // ã‚«ã‚¦ãƒ³ãƒˆ
            const introCount = countNotesDetailed(intro.lines, "Intro");
            if(introCount > 0) {
                balloonCursor += introCount;
                log(`[Intro] å‡ºåŠ›é™¤å¤–ã§ã™ãŒã€é¢¨èˆ¹æ¶ˆè²» <span class="highlight">${introCount}å€‹</span> ã‚’æ¤œçŸ¥ã—ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸã€‚`, 'warn');
            }
        }

        // --- 1æ›²ç›®ä»¥é™ ---
        for(let i=1; i<songs.length; i++) {
            const song = songs[i];
            const args = parseArgs(song.tag);
            const title = args[0] || `Song_${i}`;
            const wave = args[3] || "";
            
            // é›£æ˜“åº¦è§£æ
            let course="Oni", level="10";
            if(args.length >= 8) {
                if(parseFloat(args[6]) > 4) { level=args[6]; course=mapCourse(args[7]); }
                else { course=mapCourse(args[6]); level=args[7]; }
            }

            // â˜… ã‚«ã‚¦ãƒ³ãƒˆå®Ÿè¡Œ â˜…
            const needed = countNotesDetailed(song.lines, title);
            let assignedBalloons = [];

            // â˜… å‰²ã‚Šå½“ã¦å®Ÿè¡Œ â˜…
            if(needed > 0) {
                for(let k=0; k<needed; k++) {
                    if(balloonCursor < globalBalloons.length) {
                        assignedBalloons.push(globalBalloons[balloonCursor]);
                        balloonCursor++;
                    } else {
                        assignedBalloons.push(5);
                        log(`[${title}] <span style="color:red">ä¸è¶³ç™ºç”Ÿ</span>: å®šç¾©åˆ‡ã‚Œã®ãŸã‚ã€Œ5ã€ã‚’è£œå¡«`, 'error');
                    }
                }
                log(`[${title}] å¿…è¦æ•°:<span class="highlight">${needed}</span> â†’ å‰²å½“:<span class="highlight">[${assignedBalloons.join(',')}]</span>`, 'success');
            } else {
                log(`[${title}] é¢¨èˆ¹ãªã— (0å€‹)`, 'info');
            }

            // TJAç”Ÿæˆ
            let out = [];
            out.push(`TITLE:${title}`);
            if(args[1]) out.push(`SUBTITLE:${args[1]}`);
            out.push(`BPM:${currentBpm}`);
            out.push(`WAVE:${wave}`);
            out.push(`OFFSET:0`);
            out.push(`GENRE:${args[2]||""}`);
            out.push(`COURSE:${course}`);
            out.push(`LEVEL:${level}`);
            
            // â˜… BALLOONæ›¸ãè¾¼ã¿ â˜…
            // æ•°å€¤ãŒãªãã¦ã‚‚ç©ºã®BALLOON:è¡Œã‚’ä½œã‚‹ã‹ã€æ•°å€¤ãŒã‚ã‚Œã°å…¥ã‚Œã‚‹
            if(assignedBalloons.length > 0) {
                out.push(`BALLOON:${assignedBalloons.join(',')}`);
            } else {
                out.push(`BALLOON:`);
            }

            out.push(`SCOREINIT:${args[4]||""}`);
            out.push(`SCOREDIFF:${args[5]||""}`);
            out.push(`SCOREMODE:2`);
            out.push(''); // ç©ºè¡Œ

            // è­œé¢ãƒ‡ãƒ¼ã‚¿
            song.lines.forEach(l => {
                let u = l.trim().toUpperCase();
                if(!u.startsWith('EXAM') && !u.startsWith('#LEVELHOLD')) {
                    out.push(l);
                }
                if(u.startsWith('#BPMCHANGE')) {
                    let p = l.split(/\s+/);
                    if(p[1]) currentBpm = parseFloat(p[1]);
                }
            });

            // ZIPæ ¼ç´
            const safeName = title.replace(/[\\/:*?"<>|]/g, "_");
            const folderName = `${i}_${safeName}`;
            const folder = zip.folder(folderName);
            const suffix = (course==="Edit"||course==="4") ? "_Ura" : "";
            
            folder.file(`${safeName}${suffix}.tja`, out.join('\n'));

            if(wave) {
                const wName = wave.split(/[/\\]/).pop();
                if(fileMap.has(wName)) {
                    folder.file(wName, fileMap.get(wName));
                } else {
                    log(`[æ³¨æ„] éŸ³æºãªã—: ${wName}`, 'warn');
                }
            }
            processed++;
        }

        if(processed > 0) {
            log("ZIPç”Ÿæˆé–‹å§‹...");
            const blob = await zip.generateAsync({type:"blob"});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = targetTja.name.replace(/\.tja$/i, '') + "_split.zip";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            log("ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼", 'success');
        } else {
            log("å‡ºåŠ›å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚", 'error');
        }
    }

    function readFile(f, enc) {
        return new Promise((res,rej)=>{
            const r=new FileReader();
            r.onload=e=>res(e.target.result);
            r.onerror=rej;
            r.readAsText(f, enc);
        });
    }

    // â˜… ç–‘æƒ‘ã‚’æ™´ã‚‰ã™ãŸã‚ã®ã€è¶…å³æ ¼ãªã‚«ã‚¦ãƒ³ãƒˆé–¢æ•° â˜…
    function countNotesDetailed(lines, songTitle) {
        let count = 0;
        let isBody = false;
        
        for(let line of lines) {
            let trim = line.trim();
            let upper = trim.toUpperCase();
            
            if(upper.startsWith('#START')) { isBody = true; continue; }
            if(upper.startsWith('#END')) { isBody = false; continue; }
            
            if(isBody) {
                // 1. ã‚³ãƒ¡ãƒ³ãƒˆé™¤å»
                let clean = trim.split('//')[0];
                // 2. å‘½ä»¤æ–‡(#)ã®è¡Œã¯ç„¡è¦– (ä¾‹: #BPM 179 ã¯ 7ã‚„9ã‚’å«ã‚“ã§ã„ã¦ã‚‚ç„¡è¦–)
                if(clean.startsWith('#')) continue;
                
                // 3. æ•°å­—ä»¥å¤–ã‚’å‰Šé™¤ã—ã¦ç´”ç²‹åŒ–
                // æ–‡å­—åˆ—ã®ä¸­ã« '7' ã‹ '9' ãŒã‚ã‚‹ã‹
                for(let char of clean) {
                    if(char === '7' || char === '9') {
                        count++;
                    }
                }
            }
        }
        return count;
    }

    function parseArgs(tag) { return tag.replace(/^#NEXTSONG\s+/i,'').split(',').map(s=>s.trim()); }
    function mapCourse(id) { const m=["Easy","Normal","Hard","Oni","Edit"]; return m[parseInt(id)]||"Oni"; }
</script>

</body>
</html>
