<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ®µä½TJA ä¿®æ­£ãƒ„ãƒ¼ãƒ« (å³æ ¼å®šç¾©ç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --accent: #ff9800; /* æ³¨æ„æ·±ã•ã®ã‚ªãƒ¬ãƒ³ã‚¸ */
            --text-main: #e0e0e0;
            --text-sub: #b0b0b0;
            --log-bg: #000000;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            width: 100%;
            max-width: 850px;
            background: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.5);
        }
        h1 {
            color: var(--accent);
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8rem;
            border-bottom: 2px solid #333;
            padding-bottom: 15px;
            letter-spacing: 1px;
        }
        .desc {
            margin-bottom: 20px;
            color: var(--text-sub);
            line-height: 1.6;
            font-size: 0.95rem;
            background: #252525;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid var(--accent);
        }
        .upload-box {
            border: 2px dashed #444;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #252525;
        }
        .upload-box:hover {
            border-color: var(--accent);
            background: #2a2a2a;
        }
        .upload-box p { margin: 0; font-size: 1.1rem; color: #aaa; }
        
        button {
            width: 100%;
            padding: 15px;
            background-color: var(--accent);
            color: #000;
            border: none;
            border-radius: 6px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
            opacity: 0.5;
            pointer-events: none;
            margin-top: 25px;
        }
        button.active { opacity: 1; pointer-events: auto; }
        button:hover { filter: brightness(1.2); transform: translateY(-2px); }
        
        #log {
            margin-top: 20px;
            background: var(--log-bg);
            padding: 15px;
            border-radius: 6px;
            height: 350px;
            overflow-y: auto;
            font-family: Consolas, monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            border: 1px solid #333;
        }
        .log-info { color: #81d4fa; }
        .log-success { color: #a5d6a7; }
        .log-warn { color: #fff59d; }
        .log-err { color: #ef9a9a; }
        .log-fix { color: #ce93d8; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>æ®µä½TJA ä¿®æ­£ãƒ„ãƒ¼ãƒ« (ä»•æ§˜ç¢ºå®šç‰ˆ)</h1>
    <div class="desc">
        <strong>å‡¦ç†å†…å®¹ï¼š</strong>
        <ul>
            <li><strong>#NEXTSONGã®å³æ ¼èª­ã¿è¾¼ã¿:</strong> 2ç•ªç›®ã‚’SUBTITLEã€4ç•ªç›®ã‚’WAVEã¨ã—ã¦å‡¦ç†</li>
            <li><strong>DELAY â†’ OFFSETå¤‰æ›:</strong> #DELAYå€¤ã‚’åˆè¨ˆã—ã€OFFSETï¼ˆãƒã‚¤ãƒŠã‚¹å€¤ï¼‰ã¸å¤‰æ›</li>
            <li><strong>ä¸è¦å‘½ä»¤ã®å‰Šé™¤:</strong> EXAM, LEVELHOLD, SECTION, DELAY ã‚’å®Œå…¨é™¤å»</li>
            <li><strong>åŸºæœ¬è£œæ­£:</strong> #START/#ENDä»˜ä¸ã€é¢¨èˆ¹ã®å†åˆ†é…</li>
        </ul>
    </div>

    <div class="upload-box" id="dropZone" onclick="document.getElementById('fileInput').click()">
        <p>ğŸ“‚ ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ (ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—å¯)</p>
        <input type="file" id="fileInput" webkitdirectory directory multiple style="display:none">
    </div>
    <div id="file-status" style="text-align:center; margin-top:10px; font-weight:bold; color:var(--text-main);"></div>

    <button id="runBtn">å¤‰æ›ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>

    <div id="log">ãƒ­ã‚°å¾…æ©Ÿä¸­...</div>
</div>

<script>
    // --- å¤‰æ•°å®šç¾© ---
    const fileInput = document.getElementById('fileInput');
    const dropZone = document.getElementById('dropZone');
    const runBtn = document.getElementById('runBtn');
    const logArea = document.getElementById('log');
    const fileStatus = document.getElementById('file-status');

    let targetTjaFile = null;
    let fileMap = new Map();

    // --- ãƒ­ã‚®ãƒ³ã‚°é–¢æ•° ---
    function log(msg, type = 'info') {
        const div = document.createElement('div');
        div.textContent = msg;
        div.className = `log-${type}`;
        logArea.appendChild(div);
        logArea.scrollTop = logArea.scrollHeight;
    }

    // --- ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›å‡¦ç† ---
    fileInput.addEventListener('change', e => handleFiles(e.target.files));
    dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.style.borderColor = '#ff9800'; });
    dropZone.addEventListener('dragleave', e => { e.preventDefault(); dropZone.style.borderColor = '#444'; });
    dropZone.addEventListener('drop', e => {
        e.preventDefault();
        dropZone.style.borderColor = '#444';
        handleFiles(e.dataTransfer.files);
    });

    function handleFiles(files) {
        fileMap.clear();
        targetTjaFile = null;
        logArea.innerHTML = '';
        fileStatus.textContent = '';
        runBtn.classList.remove('active');

        const fileList = Array.from(files);
        if (fileList.length === 0) return;

        let tjaCount = 0;
        fileList.forEach(f => {
            fileMap.set(f.name, f);
            if (f.name.toLowerCase().endsWith('.tja')) {
                targetTjaFile = f;
                tjaCount++;
            }
        });

        if (targetTjaFile) {
            fileStatus.textContent = `èª­è¾¼: ${targetTjaFile.name} (ä»– ${fileList.length - 1} ãƒ•ã‚¡ã‚¤ãƒ«)`;
            log(`[æº–å‚™] ã‚¿ãƒ¼ã‚²ãƒƒãƒˆTJA: ${targetTjaFile.name}`, 'info');
            if(tjaCount > 1) log(`[æ³¨æ„] è¤‡æ•°ã®TJAãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚${targetTjaFile.name} ã‚’å‡¦ç†ã—ã¾ã™ã€‚`, 'warn');
            runBtn.classList.add('active');
        } else {
            log('[ã‚¨ãƒ©ãƒ¼] TJAãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'err');
        }
    }

    // --- ãƒ¡ã‚¤ãƒ³å‡¦ç†å®Ÿè¡Œ ---
    runBtn.addEventListener('click', async () => {
        if (!targetTjaFile) return;
        runBtn.textContent = "å‡¦ç†ä¸­...";
        runBtn.classList.remove('active');

        try {
            await processTja();
            runBtn.textContent = "å®Œäº†ï¼";
        } catch (e) {
            console.error(e);
            log(`[è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼] ${e.message}`, 'err');
            runBtn.textContent = "ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ";
        }
        
        setTimeout(() => {
            runBtn.classList.add('active');
            runBtn.textContent = "å¤‰æ›ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰";
        }, 3000);
    });

    // --- TJAè§£æãƒ»å¤‰æ›ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯ ---
    async function processTja() {
        const zip = new JSZip();
        
        // 1. ãƒ•ã‚¡ã‚¤ãƒ«èª­è¾¼
        let text = await readFileContent(targetTjaFile);
        const lines = text.split(/\r?\n/);

        // 2. BALLOONå…¨å–å¾—
        let globalBalloons = [];
        let tempBalloonStr = "";
        lines.forEach(l => {
            if (l.trim().toUpperCase().startsWith('BALLOON:')) {
                tempBalloonStr += l.trim().substring(8) + ",";
            }
        });
        if (tempBalloonStr) {
            globalBalloons = tempBalloonStr.split(/[,ã€\s]+/)
                .map(n => parseInt(n))
                .filter(n => !isNaN(n));
            log(`[å…¨ä½“] é¢¨èˆ¹ãƒ—ãƒ¼ãƒ«: åˆè¨ˆ ${globalBalloons.length} å€‹`, 'info');
        }

        // 3. ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ†å‰²
        let sections = [];
        let buffer = [];
        let nextTag = "";

        // BOMå¯¾ç­–
        if(lines.length > 0 && lines[0].charCodeAt(0) === 0xFEFF) lines[0] = lines[0].substr(1);

        for (let line of lines) {
            if (line.trim().toUpperCase().startsWith('#NEXTSONG')) {
                sections.push({ lines: buffer, tag: nextTag });
                buffer = [];
                nextTag = line.trim();
            } else {
                buffer.push(line);
            }
        }
        sections.push({ lines: buffer, tag: nextTag });

        // 4. å„æ›²ã®å‡¦ç†
        let balloonCursor = 0;
        let currentBpm = 0;

        // Intro (0ç•ªç›®) å‡¦ç†
        if (sections.length > 0) {
            const intro = sections[0];
            intro.lines.forEach(l => {
                if (l.trim().toUpperCase().startsWith('BPM:')) currentBpm = parseFloat(l.split(':')[1]);
            });
            const introUsed = count79(intro.lines);
            if(introUsed > 0) {
                balloonCursor += introUsed;
                log(`[Intro] è¡¨ç´™éƒ¨åˆ†ã§é¢¨èˆ¹ ${introUsed} å€‹ã‚’ã‚¹ã‚­ãƒƒãƒ—`, 'warn');
            }
        }

        // æ›² (1ç•ªç›®ä»¥é™) å‡¦ç†
        for (let i = 1; i < sections.length; i++) {
            const section = sections[i];
            const args = parseNextSongArgs(section.tag);
            
            // --- å¼•æ•°ãƒãƒƒãƒ”ãƒ³ã‚° (ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©é †) ---
            // #NEXTSONG [æ›²å],[SUBTITLE],[ã‚¸ãƒ£ãƒ³ãƒ«],[éŸ³æº],[åˆé …],[å…¬å·®],[ãƒ¬ãƒ™ãƒ«],[é›£æ˜“åº¦]
            
            const title = args[0] || `Song_${i}`;
            let subTitle = args[1] || "";     // 2ç•ªç›®: SUBTITLE
            const genre = args[2] || "";      // 3ç•ªç›®: ã‚¸ãƒ£ãƒ³ãƒ«
            const wave = args[3] || "";       // 4ç•ªç›®: éŸ³æºãƒ•ã‚¡ã‚¤ãƒ«
            const scoreInit = args[4] || "";  // 5ç•ªç›®: åˆé …
            const scoreDiff = args[5] || "";  // 6ç•ªç›®: å…¬å·®
            
            // SUBTITLEãŒ "--" ã®å ´åˆã¯ç©ºã«ã™ã‚‹
            if (subTitle === "--") subTitle = "";

            // é›£æ˜“åº¦/ãƒ¬ãƒ™ãƒ«å‡¦ç† (7, 8ç•ªç›®)
            let course = "Oni"; 
            let level = "10";
            if (args.length >= 8) {
                // ä¸€èˆ¬çš„ã«ã€æ•°å€¤ãŒå°ã•ã„ã»ã†ãŒé›£æ˜“åº¦(Oniç­‰)ã€å¤§ãã„ã»ã†ãŒãƒ¬ãƒ™ãƒ«(10ç­‰)ã§ã‚ã‚‹å ´åˆãŒå¤šã„ãŒ
                // ã“ã“ã§ã¯å˜ç´”ã«ä¸¦ã³é †ã§å‡¦ç†ã—ã¤ã¤ã€å€¤ã«ã‚ˆã‚‹å®‰å…¨ç­–ã‚’ã¨ã‚‹
                if (parseFloat(args[6]) > 4) { 
                    // 7ç•ªç›®ãŒãƒ¬ãƒ™ãƒ«ã£ã½ã„å ´åˆ
                    level = args[6]; 
                    course = mapCourse(args[7]); 
                } else { 
                    // 7ç•ªç›®ãŒé›£æ˜“åº¦IDã£ã½ã„å ´åˆ
                    course = mapCourse(args[6]); 
                    level = args[7]; 
                }
            } else if(args[6]) {
                 level = args[6];
            }

            // --- é¢¨èˆ¹åˆ†é… ---
            const needed = count79(section.lines);
            let myBalloons = [];
            for(let k=0; k<needed; k++) {
                if(balloonCursor < globalBalloons.length) {
                    myBalloons.push(globalBalloons[balloonCursor]);
                    balloonCursor++;
                } else {
                    myBalloons.push(5);
                    log(`[${title}] é¢¨èˆ¹ä¸è¶³: 5ã‚’è£œå¡«`, 'warn');
                }
            }

            // --- è­œé¢ãƒ‡ãƒ¼ã‚¿ã®ä¿®æ­£ & DELAYè§£æ ---
            let bodyLines = [];
            let totalDelay = 0.0;
            
            section.lines.forEach(l => {
                const t = l.trim().toUpperCase();
                
                // å‰Šé™¤å¯¾è±¡ãƒ•ã‚£ãƒ«ã‚¿ (EXAM, LEVELHOLD, SECTION, START, END, BALLOON)
                if (t.startsWith('EXAM')) return;
                if (t.startsWith('#LEVELHOLD')) return;
                if (t.startsWith('#SECTION')) return;
                if (t.startsWith('#START')) return; 
                if (t.startsWith('#END')) return; 
                if (t.startsWith('BALLOON:')) return; 

                // DELAYè§£æ
                if (t.startsWith('#DELAY')) {
                    const val = parseFloat(l.trim().split(/\s+/)[1]);
                    if (!isNaN(val)) {
                        totalDelay += val;
                    }
                    return; // è¡Œè‡ªä½“ã¯å‰Šé™¤
                }
                
                // BPMè¿½è·¡
                if (t.startsWith('#BPMCHANGE')) {
                    const parts = l.trim().split(/\s+/);
                    if (parts[1]) currentBpm = parseFloat(parts[1]);
                }
                
                bodyLines.push(l);
            });

            if (totalDelay !== 0) {
                log(`[${title}] DELAY: ${totalDelay}s -> OFFSETã¸åæ˜ `, 'fix');
            }

            // --- å‡ºåŠ›ç”¨TJAæ§‹ç¯‰ ---
            let outLines = [];
            outLines.push(`TITLE:${title}`);
            if(subTitle) outLines.push(`SUBTITLE:${subTitle}`);
            outLines.push(`BPM:${currentBpm}`);
            outLines.push(`WAVE:${wave}`);
            
            // DELAYã‚’OFFSET(ãƒã‚¤ãƒŠã‚¹)ã«å¤‰æ›
            outLines.push(`OFFSET:${-totalDelay}`);
            
            outLines.push(`GENRE:${genre}`);
            outLines.push(`COURSE:${course}`);
            outLines.push(`LEVEL:${level}`);
            outLines.push(`BALLOON:${myBalloons.join(',')}`);
            outLines.push(`SCOREINIT:${scoreInit}`);
            outLines.push(`SCOREDIFF:${scoreDiff}`);
            outLines.push(`SCOREMODE:2`);
            outLines.push('');
            
            outLines.push('#START');
            outLines = outLines.concat(bodyLines);
            if (outLines[outLines.length-1].trim() !== "") outLines.push("");
            outLines.push('#END');

            // --- ZIPã«è¿½åŠ  ---
            const safeTitle = title.replace(/[\\/:*?"<>|]/g, "_");
            const folderName = `${i}_${safeTitle}`;
            const folder = zip.folder(folderName);
            
            folder.file(`${safeTitle}.tja`, outLines.join('\r\n'));
            
            // éŸ³æºã‚³ãƒ”ãƒ¼
            if (wave) {
                const waveFileName = wave.split(/[/\\]/).pop();
                if (fileMap.has(waveFileName)) {
                    folder.file(waveFileName, fileMap.get(waveFileName));
                } else {
                    log(`[${title}] éŸ³æºãƒ•ã‚¡ã‚¤ãƒ«ãªã—: ${waveFileName}`, 'warn');
                }
            }
        }

        // 5. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        const content = await zip.generateAsync({type:"blob"});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(content);
        link.download = targetTjaFile.name.replace(/\.tja$/i, "") + "_fixed_final.zip";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        log("å…¨å‡¦ç†å®Œäº†ã€‚ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚", 'success');
    }

    // --- è£œåŠ©é–¢æ•° ---
    function count79(lines) {
        let count = 0;
        for (let line of lines) {
            let trim = line.trim();
            if (!trim) continue;
            let code = trim.split('//')[0].trim();
            if (!code) continue;
            if (code.includes(':') || code.startsWith('#')) continue;
            
            for (let char of code) {
                if (char === '7' || char === '9') count++;
            }
        }
        return count;
    }

    function readFileContent(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const buffer = e.target.result;
                const decoderSJIS = new TextDecoder('shift-jis');
                const textSJIS = decoderSJIS.decode(buffer);
                
                if (textSJIS.includes('TITLE:') || textSJIS.includes('#NEXTSONG') || textSJIS.includes('COURSE:')) {
                    resolve(textSJIS);
                } else {
                    const decoderUTF8 = new TextDecoder('utf-8');
                    resolve(decoderUTF8.decode(buffer));
                }
            };
            reader.onerror = reject;
            reader.readAsArrayBuffer(file);
        });
    }

    function parseNextSongArgs(tag) {
        const raw = tag.replace(/^#NEXTSONG\s+/i, '');
        // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§é…åˆ—åŒ–
        return raw.split(',').map(s => s.trim());
    }

    function mapCourse(val) {
        const map = ["Easy", "Normal", "Hard", "Oni", "Edit"];
        const idx = parseInt(val);
        return map[idx] || "Oni";
    }

</script>
</body>
</html>
