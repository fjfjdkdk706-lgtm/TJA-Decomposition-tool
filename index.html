<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>æ®µä½TJAåˆ†å‰²ãƒ„ãƒ¼ãƒ« (BALLOONå®Œå…¨è¿½è·¡ç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #f4f4f9; padding: 20px; display: flex; justify-content: center; }
        .card { background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); width: 100%; max-width: 700px; }
        h1 { margin-top: 0; color: #333; font-size: 1.4rem; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .file-area { border: 2px dashed #aaa; padding: 20px; text-align: center; margin-bottom: 20px; border-radius: 6px; background: #fafafa; cursor: pointer; }
        .file-area:hover { background: #eef; border-color: #66d; }
        button { width: 100%; padding: 15px; background: #28a745; color: white; font-weight: bold; border: none; border-radius: 5px; cursor: pointer; font-size: 1.1rem; opacity: 0.5; pointer-events: none; }
        button.active { opacity: 1; pointer-events: auto; }
        button:hover { background: #218838; }
        #log { margin-top: 20px; background: #222; color: #0f0; padding: 10px; height: 300px; overflow-y: scroll; font-family: monospace; font-size: 0.85rem; border-radius: 4px; white-space: pre-wrap; }
        .err { color: #ff5555; } .warn { color: #ffcc00; }
    </style>
</head>
<body>

<div class="card">
    <h1>æ®µä½TJA åˆ†å‰²ãƒ»ç”Ÿæˆãƒ„ãƒ¼ãƒ« (BALLOONå³æ ¼ãƒ¢ãƒ¼ãƒ‰)</h1>
    
    <div class="file-area" onclick="document.getElementById('fileInput').click()">
        <p>ğŸ“‚ ã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ</p>
        <input type="file" id="fileInput" webkitdirectory directory multiple style="display:none">
        <div id="file-status" style="font-weight:bold; color:#555;">æœªé¸æŠ</div>
    </div>

    <button id="runBtn">å®Ÿè¡Œãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
    <div id="log">ãƒ­ã‚°å¾…æ©Ÿä¸­...</div>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const statusDiv = document.getElementById('file-status');
    const runBtn = document.getElementById('runBtn');
    const logDiv = document.getElementById('log');

    let targetTja = null;
    let fileMap = new Map();

    function log(msg, type='') {
        const line = document.createElement('div');
        line.textContent = msg;
        if(type==='err') line.className = 'err';
        if(type==='warn') line.className = 'warn';
        logDiv.appendChild(line);
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    fileInput.addEventListener('change', (e) => {
        fileMap.clear();
        targetTja = null;
        logDiv.innerHTML = '';
        
        const files = Array.from(e.target.files);
        if(files.length === 0) return;

        files.forEach(f => {
            fileMap.set(f.name, f);
            if(f.name.toLowerCase().endsWith('.tja')) targetTja = f;
        });

        if(targetTja) {
            statusDiv.textContent = `èª­è¾¼å¯¾è±¡: ${targetTja.name}`;
            log(`æº–å‚™å®Œäº†: ${targetTja.name} ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚`);
            runBtn.classList.add('active');
        } else {
            statusDiv.textContent = "ã‚¨ãƒ©ãƒ¼: .tjaãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";
            log("ã‚¨ãƒ©ãƒ¼: ãƒ•ã‚©ãƒ«ãƒ€å†…ã« .tja ãŒã‚ã‚Šã¾ã›ã‚“ã€‚", 'err');
        }
    });

    runBtn.addEventListener('click', async () => {
        if(!targetTja) return;
        runBtn.disabled = true;
        runBtn.textContent = "å‡¦ç†ä¸­...";
        try {
            await process();
            runBtn.textContent = "å®Œäº†ï¼";
        } catch(e) {
            log("è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼: " + e.message, 'err');
            console.error(e);
        }
        setTimeout(() => {
            runBtn.disabled = false;
            runBtn.textContent = "å®Ÿè¡Œãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰";
        }, 3000);
    });

    // --- ãƒ¡ã‚¤ãƒ³å‡¦ç† ---
    async function process() {
        // 1. ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ (Shift-JISå„ªå…ˆ)
        let text = await readFile(targetTja, 'shift-jis');
        if(!text.includes('TITLE:') && !text.includes('#NEXTSONG')) {
            log("Shift-JISã§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã€UTF-8ã§å†è©¦è¡Œ...", 'warn');
            text = await readFile(targetTja, 'utf-8');
        }

        const lines = text.split(/\r?\n/);
        const zip = new JSZip();

        // 2. BALLOONã‚¿ã‚°ã®å®Œå…¨æŠ½å‡º
        // ãƒ•ã‚¡ã‚¤ãƒ«ã®ã©ã“ã«ã‚ã£ã¦ã‚‚ã€æ”¹è¡Œã•ã‚Œã¦ã„ã¦ã‚‚å–å¾—ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
        let globalBalloons = [];
        let balloonStr = "";
        
        // å˜ç´”ãªè¡Œæ¤œç´¢ã§ã¯ãªãã€çµåˆã—ã¦ã‹ã‚‰æ¢ã™æ–¹ãŒå®‰å…¨ã ãŒã€ä»Šå›ã¯è¡ŒæŒ‡å‘ã§æ¢ç´¢
        for(let line of lines) {
            let t = line.trim();
            if(t.toUpperCase().startsWith('BALLOON:')) {
                // "BALLOON:" ä»¥é™ã®æ–‡å­—åˆ—ã‚’å–å¾—
                let val = t.substring(8).trim();
                if(val) balloonStr += val;
                // â€»è¤‡æ•°è¡Œã«ã¾ãŸãŒã‚‹BALLOONè¨˜è¿°ã¯ç¨€ã ãŒã€åŸºæœ¬ã¯1è¡Œæƒ³å®š
                // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§é…åˆ—åŒ–
                globalBalloons = balloonStr.split(/[,ã€\s]+/)
                    .map(n => parseInt(n))
                    .filter(n => !isNaN(n));
                break; // æœ€åˆã«è¦‹ã¤ã‘ãŸå®šç¾©ã‚’æ¡ç”¨
            }
        }
        
        if(globalBalloons.length > 0) {
            log(`å…¨ä½“BALLOONå®šç¾©: ${globalBalloons.length}å€‹ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸã€‚`);
        } else {
            log(`è­¦å‘Š: BALLOONå®šç¾©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å…¨ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤(5)ã«ãªã‚Šã¾ã™ã€‚`, 'warn');
        }

        // 3. æ›²ã”ã¨ã®åˆ†å‰²
        let songs = [];
        let buffer = [];
        let nextTag = "";

        for(let line of lines) {
            if(line.charCodeAt(0)===0xFEFF) line = line.substr(1); // BOMå‰Šé™¤
            let upper = line.trim().toUpperCase();

            if(upper.startsWith('#NEXTSONG')) {
                songs.push({ lines: buffer, tag: nextTag });
                buffer = [];
                nextTag = line.trim();
            } else {
                buffer.push(line);
            }
        }
        songs.push({ lines: buffer, tag: nextTag }); // æœ€å¾Œã®æ›²

        // 4. è§£æã¨ZIPç”Ÿæˆãƒ«ãƒ¼ãƒ—
        let balloonCursor = 0; // é…åˆ—ã®ã©ã“ã¾ã§ä½¿ã£ãŸã‹
        let currentBpm = 0;

        // --- 0æ›²ç›®ï¼ˆã‚¤ãƒ³ãƒˆãƒ­ï¼‰ã®å‡¦ç† ---
        if(songs.length > 0) {
            const intro = songs[0];
            // BPMç¢ºä¿
            intro.lines.forEach(l => {
                if(l.trim().toUpperCase().startsWith('BPM:')) currentBpm = parseFloat(l.split(':')[1]);
            });
            // é¢¨èˆ¹æ¶ˆè²»
            const introCount = countNotes(intro.lines);
            if(introCount > 0) {
                balloonCursor += introCount;
                log(`[Intro] å‡ºåŠ›ã—ã¾ã›ã‚“ãŒã€é¢¨èˆ¹ã‚’ ${introCount}å€‹ æ¶ˆè²»ã—ã¾ã—ãŸã€‚(Next Index: ${balloonCursor})`);
            }
        }

        // --- 1æ›²ç›®ä»¥é™ã®å‡¦ç† ---
        let processed = 0;
        for(let i=1; i<songs.length; i++) {
            const song = songs[i];
            const args = parseArgs(song.tag);
            
            const title = args[0] || `Song_${i}`;
            const wave = args[3] || "";
            const genre = args[2] || "";
            
            // é›£æ˜“åº¦è§£æ
            let course="Oni", level="10";
            if(args.length >= 8) {
                if(parseFloat(args[6]) > 4) { level=args[6]; course=mapCourse(args[7]); }
                else { course=mapCourse(args[6]); level=args[7]; }
            }

            // â˜…ã“ã“ãŒæ ¸å¿ƒï¼šé¢¨èˆ¹ã®æ•°ã‚’æ•°ãˆã€é…åˆ—ã‹ã‚‰åˆ‡ã‚Šå‡ºã™â˜…
            const needed = countNotes(song.lines);
            let myBalloons = [];

            if(needed > 0) {
                log(`[${title}] å¿…è¦é¢¨èˆ¹æ•°: ${needed}å€‹ (Index: ${balloonCursor}ã€œ)`);
                for(let k=0; k<needed; k++) {
                    if(balloonCursor < globalBalloons.length) {
                        myBalloons.push(globalBalloons[balloonCursor]);
                        balloonCursor++;
                    } else {
                        // ãƒ‡ãƒ¼ã‚¿ä¸è¶³æ™‚ã¯5ã‚’å…¥ã‚Œã‚‹
                        myBalloons.push(5);
                        log(`  -> è­¦å‘Š: å®šç¾©ä¸è¶³ã®ãŸã‚5ã‚’è£œå¡«ã—ã¾ã—ãŸ`, 'warn');
                    }
                }
            } else {
                log(`[${title}] é¢¨èˆ¹ãªã—`);
            }

            // TJAç”Ÿæˆ
            let out = [];
            out.push(`TITLE:${title}`);
            if(args[1]) out.push(`SUBTITLE:${args[1]}`);
            out.push(`BPM:${currentBpm}`);
            out.push(`WAVE:${wave}`);
            out.push(`OFFSET:0`);
            out.push(`GENRE:${genre}`);
            out.push(`COURSE:${course}`);
            out.push(`LEVEL:${level}`);
            
            // â˜…çµ¶å¯¾ã«æ•°å€¤ã‚’å…¥ã‚Œã‚‹å‡¦ç†
            if(myBalloons.length > 0) {
                out.push(`BALLOON:${myBalloons.join(',')}`);
            } else {
                out.push(`BALLOON:`);
            }

            out.push(`SCOREINIT:${args[4]||""}`);
            out.push(`SCOREDIFF:${args[5]||""}`);
            out.push(`SCOREMODE:2`);
            out.push('');

            // è­œé¢æ›¸ãå‡ºã—
            song.lines.forEach(l => {
                let t = l.trim().toUpperCase();
                if(!t.startsWith('EXAM') && !t.startsWith('#LEVELHOLD')) {
                    out.push(l);
                }
                if(t.startsWith('#BPMCHANGE')) {
                    let p = l.split(/\s+/);
                    if(p[1]) currentBpm = parseFloat(p[1]);
                }
            });

            // ZIPæ ¼ç´
            const safeName = title.replace(/[\\/:*?"<>|]/g, "_");
            const fName = `${i}_${safeName}`;
            const folder = zip.folder(fName);
            const diffSuffix = (course==="Edit"||course==="4") ? "_Ura" : "";
            
            folder.file(`${safeName}${diffSuffix}.tja`, out.join('\n'));
            
            if(wave && fileMap.has(wave.split(/[/\\]/).pop())) {
                folder.file(wave.split(/[/\\]/).pop(), fileMap.get(wave.split(/[/\\]/).pop()));
            }

            processed++;
        }

        if(processed > 0) {
            log("ZIPç”Ÿæˆé–‹å§‹...");
            const blob = await zip.generateAsync({type:"blob"});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = targetTja.name.replace('.tja', '_split.zip');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            log("ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†ã€‚å„æ›²ã®TJAã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚", 'success');
        } else {
            log("å‡ºåŠ›ã™ã‚‹æ›²ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚", 'err');
        }
    }

    // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
    function readFile(f, enc) {
        return new Promise((res,rej)=>{
            const r=new FileReader();
            r.onload=e=>res(e.target.result);
            r.onerror=rej;
            r.readAsText(f, enc);
        });
    }

    // 7(é¢¨èˆ¹)ã¨9(ãã™ç‰)ã‚’æ•°ãˆã‚‹å³æ ¼ãªé–¢æ•°
    function countNotes(lines) {
        let count = 0;
        let isBody = false;
        for(let line of lines) {
            let t = line.trim().toUpperCase();
            if(t.startsWith('#START')) isBody = true;
            if(t.startsWith('#END')) isBody = false;
            
            if(isBody) {
                // ã‚³ãƒ¡ãƒ³ãƒˆã‚’é™¤å¤–
                let clean = line.split('//')[0];
                // å‘½ä»¤ã‚’é™¤å¤–
                if(clean.trim().startsWith('#')) continue;
                
                for(let c of clean) {
                    if(c === '7' || c === '9') count++;
                }
            }
        }
        return count;
    }

    function parseArgs(tag) { return tag.replace(/^#NEXTSONG\s+/i,'').split(',').map(s=>s.trim()); }
    function mapCourse(id) { const m=["Easy","Normal","Hard","Oni","Edit"]; return m[parseInt(id)]||"Oni"; }
</script>

</body>
</html>
