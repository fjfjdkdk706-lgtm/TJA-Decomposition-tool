<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ®µä½ãƒ•ã‚©ãƒ«ãƒ€åˆ†å‰²ãƒ„ãƒ¼ãƒ« (å®Œå…¨ç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }
        .container {
            background: white;
            width: 100%;
            max-width: 650px;
            padding: 2.5rem;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            text-align: center;
        }
        h1 { margin-bottom: 0.5rem; color: #1a202c; }
        p.subtitle { color: #718096; margin-bottom: 2rem; font-size: 0.9rem; }

        /* UI Components */
        .file-box {
            border: 2px dashed #cbd5e0;
            border-radius: 10px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            background: #f7fafc;
            transition: 0.3s;
        }
        .file-box:hover { border-color: #4299e1; background: #ebf8ff; }
        
        input[type="file"] { display: none; }
        .btn-select {
            background: #4a5568; color: white;
            padding: 12px 24px; border-radius: 8px;
            font-weight: bold; cursor: pointer;
            display: inline-block;
            transition: 0.2s;
        }
        .btn-select:hover { background: #2d3748; }

        #file-info {
            font-weight: bold; margin-top: 10px; min-height: 1.5em; color: #2b6cb0;
        }

        #run-btn {
            width: 100%; padding: 16px;
            font-size: 1.1rem; font-weight: bold;
            color: white; background: #3182ce;
            border: none; border-radius: 8px;
            cursor: pointer; transition: 0.2s;
            opacity: 0.5; pointer-events: none;
        }
        #run-btn.active { opacity: 1; pointer-events: auto; }
        #run-btn:hover { background: #2c5282; }

        /* Log */
        #log {
            margin-top: 1.5rem; text-align: left;
            background: #1a202c; color: #48bb78;
            padding: 1rem; border-radius: 6px;
            font-family: monospace; font-size: 0.85rem;
            max-height: 200px; overflow-y: auto;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>æ®µä½ãƒ•ã‚©ãƒ«ãƒ€åˆ†å‰²ãƒ„ãƒ¼ãƒ«</h1>
    <p class="subtitle">BALLOONåˆ†å‰²ãƒ­ã‚¸ãƒƒã‚¯æ­è¼‰ãƒ»éŸ³å£°è‡ªå‹•åŒæ¢±ãƒ»Introå‰Šé™¤</p>

    <div class="file-box">
        <label for="folderInput" class="btn-select">ğŸ“‚ ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ</label>
        <input type="file" id="folderInput" webkitdirectory directory multiple>
        <div id="file-info">æœªé¸æŠ</div>
    </div>

    <button id="run-btn">å®Ÿè¡Œã—ã¦ZIPã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>

    <div id="log">å¾…æ©Ÿä¸­...</div>
</div>

<script>
    const folderInput = document.getElementById('folderInput');
    const fileInfo = document.getElementById('file-info');
    const runBtn = document.getElementById('run-btn');
    const logDiv = document.getElementById('log');

    let targetTja = null;
    let filesMap = new Map();

    function log(msg) {
        const time = new Date().toLocaleTimeString();
        logDiv.innerHTML = `[${time}] ${msg}<br>` + logDiv.innerHTML;
    }

    // 1. ãƒ•ã‚©ãƒ«ãƒ€é¸æŠæ™‚ã®å‡¦ç†
    folderInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        filesMap.clear();
        targetTja = null;

        if (files.length === 0) return;

        let tjaCount = 0;
        files.forEach(f => {
            filesMap.set(f.name, f);
            if (f.name.toLowerCase().endsWith('.tja')) {
                targetTja = f;
                tjaCount++;
            }
        });

        if (targetTja) {
            fileInfo.innerHTML = `TJAæ¤œå‡º: ${targetTja.name}<br><span style="font-size:0.8em; color:#718096">ä»– ${files.length-1} ãƒ•ã‚¡ã‚¤ãƒ«</span>`;
            runBtn.classList.add('active');
            log(`æº–å‚™å®Œäº†: ${targetTja.name} ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚`);
        } else {
            fileInfo.innerHTML = `<span style="color:red">ã‚¨ãƒ©ãƒ¼: .tjaãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</span>`;
            runBtn.classList.remove('active');
        }
    });

    // 2. å®Ÿè¡Œå‡¦ç†
    runBtn.addEventListener('click', async () => {
        if (!targetTja) return;
        runBtn.disabled = true;
        runBtn.innerText = "å‡¦ç†ä¸­...";
        
        try {
            await processTja(targetTja);
            runBtn.innerText = "å®Œäº†ï¼";
        } catch (err) {
            console.error(err);
            log(`ã‚¨ãƒ©ãƒ¼: ${err.message}`);
            runBtn.innerText = "ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ";
        } finally {
            setTimeout(() => {
                runBtn.disabled = false;
                runBtn.innerText = "å®Ÿè¡Œã—ã¦ZIPã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰";
            }, 3000);
        }
    });

    // 3. ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯
    async function processTja(file) {
        log("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£æä¸­...");
        
        // æ–‡å­—ã‚³ãƒ¼ãƒ‰åˆ¤å®šã¨èª­ã¿è¾¼ã¿
        let text = await readFile(file, 'shift-jis');
        if (!text.includes('TITLE:') && !text.includes('SIDE:') && !text.includes('#NEXTSONG')) {
            log("UTF-8ã§å†èª­ã¿è¾¼ã¿ã—ã¾ã™...");
            text = await readFile(file, 'utf-8');
        }

        const lines = text.split(/\r?\n/);
        const zip = new JSZip();

        // --- å¤‰æ•°å®šç¾© ---
        let songs = [];
        let currentSongLines = [];
        let nextSongTag = ""; // æ¬¡ã®æ›²ã®ãŸã‚ã®ã‚¿ã‚°
        let globalBalloonData = []; // å…¨ä½“ã®BALLOONé…åˆ—
        let isGlobalArea = true;

        // --- Step 1: è¡Œã”ã¨ã®è§£æã¨åˆ†å‰² ---
        for (let line of lines) {
            if (line.charCodeAt(0) === 0xFEFF) line = line.substr(1);
            const trimLine = line.trim();
            const upper = trimLine.toUpperCase();

            // ã‚°ãƒ­ãƒ¼ãƒãƒ«BALLOONã®å–å¾—
            if (isGlobalArea && upper.startsWith('BALLOON:')) {
                const val = trimLine.substring(8).trim();
                // å…¨è§’ã‚«ãƒ³ãƒç­‰ã‚‚å¯¾å¿œã—ã¦é…åˆ—åŒ–
                if (val) globalBalloonData = val.split(/[,ã€]/).map(n => parseInt(n.trim()) || 0);
                log(`é¢¨èˆ¹ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º: ${globalBalloonData.length}å€‹ ç™ºè¦‹`);
            }

            // #STARTãŒå‡ºãŸã‚‰ã‚°ãƒ­ãƒ¼ãƒãƒ«é ˜åŸŸçµ‚äº†
            if (upper.startsWith('#START')) isGlobalArea = false;

            // #NEXTSONGã§æ›²ã‚’åŒºåˆ‡ã‚‹
            if (upper.startsWith('#NEXTSONG')) {
                songs.push({ lines: currentSongLines, tag: nextSongTag });
                currentSongLines = [];
                nextSongTag = trimLine; // æ¬¡ã®æ›²ã®ã‚¿ã‚°ã¨ã—ã¦ä¿å­˜
                isGlobalArea = false; // å¿µã®ãŸã‚
            } else {
                currentSongLines.push(line);
            }
        }
        // æœ€å¾Œã®æ›²ã‚’è¿½åŠ 
        songs.push({ lines: currentSongLines, tag: nextSongTag });

        // --- Step 2: ãƒ‡ãƒ¼ã‚¿ã®å†æ§‹æˆã¨ZIPåŒ– ---
        
        // ã‚«ãƒ¼ã‚½ãƒ«ç®¡ç†
        let balloonIndex = 0; // é¢¨èˆ¹é…åˆ—ã®ç¾åœ¨ã®ä½ç½®
        let currentBpm = 0;   // BPMç¶™æ‰¿ç”¨

        // 1æ›²ç›®ï¼ˆã‚¤ãƒ³ãƒˆãƒ­ï¼‰ã®å‡¦ç†
        if (songs.length > 0) {
            const intro = songs[0];
            // BPMå–å¾—
            intro.lines.forEach(l => {
                if(l.trim().toUpperCase().startsWith('BPM:')) currentBpm = parseFloat(l.split(':')[1]);
            });
            // â˜…é‡è¦: ã‚¤ãƒ³ãƒˆãƒ­ã§ä½¿ã‚ã‚Œã¦ã„ã‚‹é¢¨èˆ¹ã®æ•°ã ã‘ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’é€²ã‚ã‚‹ï¼ˆã€Œå¤±ã‚ã‚ŒãŸæŠ€è¡“ã€ã®å¾©æ´»ï¼‰
            const introBalloons = countBalloons(intro.lines);
            balloonIndex += introBalloons;
            log(`ã‚¤ãƒ³ãƒˆãƒ­å‡¦ç†: é¢¨èˆ¹ã‚’${introBalloons}å€‹æ¶ˆè²»ã—ã¾ã—ãŸã€‚æ¬¡ã®é¢¨èˆ¹ã¯ ${globalBalloonData[balloonIndex]}æ‰“ ã‹ã‚‰å§‹ã¾ã‚Šã¾ã™ã€‚`);
        }

        // 2æ›²ç›®ä»¥é™ã®å‡¦ç†
        let outputCount = 0;
        for (let i = 1; i < songs.length; i++) {
            const song = songs[i];
            const args = parseArgs(song.tag); // #NEXTSONGã®å¼•æ•°è§£æ

            // å¼•æ•°: Title, Sub, Genre, Wave, Init, Diff, Level/Course...
            const title = args[0] || `Song_${i}`;
            const wave = args[3] || "";
            
            // é›£æ˜“åº¦è§£æ (OpenTaiko vs TNDE)
            let course = "Oni";
            let level = "10";
            if (args.length >= 8) {
                const v1 = parseFloat(args[6]);
                if (v1 > 4) { level = args[6]; course = mapCourse(args[7]); } // OpenTaiko
                else        { course = mapCourse(args[6]); level = args[7]; } // TNDE
            }

            // å‡ºåŠ›ç”¨TJAä½œæˆ
            let out = [];
            out.push(`TITLE:${title}`);
            if (args[1]) out.push(`SUBTITLE:${args[1]}`);
            out.push(`BPM:${currentBpm}`);
            out.push(`WAVE:${wave}`);
            out.push(`OFFSET:0`);
            out.push(`GENRE:${args[2] || ""}`);
            out.push(`COURSE:${course}`);
            out.push(`LEVEL:${level}`);
            out.push(`SCOREINIT:${args[4]||""}`);
            out.push(`SCOREDIFF:${args[5]||""}`);
            out.push(`SCOREMODE:2`);

            // â˜…é‡è¦: ã“ã®æ›²ã«å¿…è¦ãªé¢¨èˆ¹ã®æ•°ã‚’è¨ˆç®—ã—ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«é…åˆ—ã‹ã‚‰åˆ†é…
            const needed = countBalloons(song.lines);
            if (needed > 0) {
                const assigned = globalBalloonData.slice(balloonIndex, balloonIndex + needed);
                out.push(`BALLOON:${assigned.join(',')}`);
                balloonIndex += needed;
                // log(`[${title}] é¢¨èˆ¹:${assigned.join(',')}`);
            } else {
                out.push(`BALLOON:`);
            }
            out.push(''); // ç©ºè¡Œ

            // è­œé¢ãƒ‡ãƒ¼ã‚¿ (EXAMãªã©ã¯é™¤å»)
            song.lines.forEach(l => {
                const t = l.trim().toUpperCase();
                if (!t.startsWith('EXAM') && !t.startsWith('#LEVELHOLD')) {
                    out.push(l);
                }
                // BPMè¿½è·¡
                if (t.startsWith('#BPMCHANGE')) {
                    const p = l.split(/\s+/);
                    if(p[1]) currentBpm = parseFloat(p[1]);
                }
            });

            // ZIPã¸ä¿å­˜
            const safeTitle = title.replace(/[\\/:*?"<>|]/g, '_');
            const folderName = `${i}_${safeTitle}`;
            const folder = zip.folder(folderName);
            
            const diffSuffix = (course === "Edit" || course === "4") ? "_Ura" : "";
            folder.file(`${safeTitle}${diffSuffix}.tja`, out.join('\n'));

            // éŸ³æºåŒæ¢±
            if (wave) {
                const fName = wave.split(/[/\\]/).pop();
                if (filesMap.has(fName)) {
                    folder.file(fName, filesMap.get(fName));
                } else {
                    log(`[è­¦å‘Š] éŸ³æºãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${fName}`);
                }
            }
            outputCount++;
        }

        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        log("ZIPä½œæˆä¸­...");
        const blob = await zip.generateAsync({type:"blob"});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `${targetTja.name.replace('.tja','')}_split.zip`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        log("ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼");
    }

    // --- ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---

    function readFile(file, enc) {
        return new Promise((res, rej) => {
            const r = new FileReader();
            r.onload = e => res(e.target.result);
            r.onerror = e => rej(e);
            r.readAsText(file, enc);
        });
    }

    function parseArgs(tag) {
        return tag.replace(/^#NEXTSONG\s+/i, '').split(',').map(s => s.trim());
    }

    function mapCourse(id) {
        const i = parseInt(id);
        const map = ["Easy", "Normal", "Hard", "Oni", "Edit"];
        return map[i] || "Oni";
    }

    // â˜…é‡è¦: è­œé¢å†…ã®é¢¨èˆ¹(7)ã¨ãã™ç‰(9)ã‚’æ•°ãˆã‚‹é–¢æ•°
    function countBalloons(lines) {
        let count = 0;
        let isBody = false;
        for (let line of lines) {
            const t = line.trim().toUpperCase();
            if (t.startsWith('#START')) isBody = true;
            if (t.startsWith('#END')) isBody = false;
            
            if (isBody) {
                // ã‚³ãƒ¡ãƒ³ãƒˆã‚’é™¤å»ã—ã¦ã‹ã‚‰è§£æ
                const clean = line.split('//')[0];
                if (clean.trim().startsWith('#')) continue; // å‘½ä»¤ã¯ç„¡è¦–
                
                // 1æ–‡å­—ãšã¤ãƒã‚§ãƒƒã‚¯
                for (let char of clean) {
                    if (char === '7' || char === '9') count++;
                }
            }
        }
        return count;
    }
</script>

</body>
</html>
