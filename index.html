<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>段位フォルダ分割ツール (BALLOON修正版)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            background-color: #f4f7f6;
            color: #333;
            display: flex;
            justify-content: center;
            padding-top: 50px;
            min-height: 100vh;
            margin: 0;
        }
        .container {
            background: white;
            width: 100%;
            max-width: 720px;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
        }
        p.desc {
            text-align: center;
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-bottom: 2rem;
        }

        /* フォルダ選択エリア */
        .drop-area {
            border: 3px dashed #bdc3c7;
            border-radius: 10px;
            padding: 3rem 1rem;
            text-align: center;
            background-color: #fcfcfc;
            transition: 0.3s;
            cursor: pointer;
            margin-bottom: 1.5rem;
        }
        .drop-area:hover, .drop-area.dragover {
            border-color: #3498db;
            background-color: #ecf8ff;
        }
        .drop-area h3 { margin: 0 0 10px 0; color: #7f8c8d; }
        
        input[type="file"] { display: none; }
        
        .btn-main {
            display: block;
            width: 100%;
            padding: 15px;
            background-color: #3498db;
            color: white;
            font-size: 1.1rem;
            font-weight: bold;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.2s;
            opacity: 0.5;
            pointer-events: none;
        }
        .btn-main.active { opacity: 1; pointer-events: auto; }
        .btn-main:hover { background-color: #2980b9; }

        #status-msg {
            text-align: center;
            font-weight: bold;
            margin-top: 10px;
            min-height: 1.5em;
            color: #2c3e50;
        }

        /* ログエリア */
        #log-area {
            margin-top: 2rem;
            background: #2c3e50;
            color: #ecf0f1;
            padding: 1rem;
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.85rem;
            height: 250px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .log-warn { color: #f1c40f; }
        .log-err { color: #e74c3c; font-weight: bold; }
        .log-ok { color: #2ecc71; }
    </style>
</head>
<body>

<div class="container">
    <h1>段位フォルダ分割・生成ツール</h1>
    <p class="desc">
        段位TJAと音源が入ったフォルダを選択してください。<br>
        BALLOONデータを各曲へ正確に分配し、ZIPパッケージを作成します。
    </p>

    <div class="drop-area" id="drop-zone">
        <h3>ここにフォルダをドロップ</h3>
        <p>またはクリックして選択</p>
        <input type="file" id="folderInput" webkitdirectory directory multiple>
    </div>

    <div id="status-msg">待機中...</div>
    <button id="run-btn" class="btn-main">分割実行 ＆ ダウンロード</button>

    <div id="log-area">ここにログが表示されます</div>
</div>

<script>
    // --- 変数と要素 ---
    const dropZone = document.getElementById('drop-zone');
    const folderInput = document.getElementById('folderInput');
    const statusMsg = document.getElementById('status-msg');
    const runBtn = document.getElementById('run-btn');
    const logArea = document.getElementById('log-area');

    let targetTjaFile = null;
    let filesMap = new Map();

    // --- ログ関数 ---
    function log(msg, type='') {
        const div = document.createElement('div');
        div.textContent = `> ${msg}`;
        if(type === 'warn') div.className = 'log-warn';
        if(type === 'error') div.className = 'log-err';
        if(type === 'success') div.className = 'log-ok';
        logArea.appendChild(div);
        logArea.scrollTop = logArea.scrollHeight;
    }

    // --- ファイル入力ハンドリング ---
    
    // クリックでファイル選択ダイアログを開く
    dropZone.addEventListener('click', () => folderInput.click());

    // フォルダ選択(input)イベント
    folderInput.addEventListener('change', (e) => handleFiles(e.target.files));

    // ドラッグ＆ドロップイベント
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
    });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        
        // フォルダドロップ対応 (webkitGetAsEntry)
        const items = e.dataTransfer.items;
        if (items) {
            log("フォルダ解析開始...", 'warn');
            scanDroppedItems(items);
        } else {
            handleFiles(e.dataTransfer.files);
        }
    });

    // --- ファイル処理ロジック ---

    // FileListからの読み込み
    function handleFiles(fileList) {
        filesMap.clear();
        targetTjaFile = null;
        logArea.innerHTML = '';

        if (fileList.length === 0) return;

        let tjaCount = 0;
        Array.from(fileList).forEach(f => {
            filesMap.set(f.name, f);
            if (f.name.toLowerCase().endsWith('.tja')) {
                targetTjaFile = f;
                tjaCount++;
            }
        });

        updateUI(tjaCount);
    }

    // ドロップされたItemの再帰スキャン
    async function scanDroppedItems(items) {
        filesMap.clear();
        targetTjaFile = null;
        logArea.innerHTML = '';
        
        const entries = [];
        for (let i=0; i<items.length; i++) {
            const entry = items[i].webkitGetAsEntry ? items[i].webkitGetAsEntry() : null;
            if (entry) entries.push(entry);
        }

        await traverseTree(entries);
        
        // TJAを探す
        let tjaCount = 0;
        for (const [name, file] of filesMap) {
            if (name.toLowerCase().endsWith('.tja')) {
                targetTjaFile = file;
                tjaCount++;
            }
        }
        updateUI(tjaCount);
    }

    async function traverseTree(entries) {
        for (const entry of entries) {
            if (entry.isFile) {
                const file = await new Promise(r => entry.file(r));
                filesMap.set(file.name, file);
            } else if (entry.isDirectory) {
                const reader = entry.createReader();
                const newEntries = await new Promise(r => reader.readEntries(r));
                await traverseTree(newEntries);
            }
        }
    }

    function updateUI(tjaCount) {
        if (tjaCount > 0) {
            statusMsg.textContent = `検出: ${targetTjaFile.name}`;
            statusMsg.style.color = "#27ae60";
            log(`TJAファイルを発見: ${targetTjaFile.name}`, 'success');
            runBtn.classList.add('active');
        } else {
            statusMsg.textContent = "エラー: .tjaファイルが見つかりません";
            statusMsg.style.color = "#c0392b";
            log("エラー: フォルダ内に .tja ファイルがありません。", 'error');
            runBtn.classList.remove('active');
        }
    }

    // --- 実行ボタン ---
    runBtn.addEventListener('click', async () => {
        if (!targetTjaFile) return;
        runBtn.disabled = true;
        runBtn.innerText = "処理中...";
        
        try {
            await processTjaAndZip(targetTjaFile);
            runBtn.innerText = "完了！";
        } catch (err) {
            console.error(err);
            log(`エラー発生: ${err.message}`, 'error');
            runBtn.innerText = "エラー";
        } finally {
            setTimeout(() => {
                runBtn.disabled = false;
                runBtn.innerText = "分割実行 ＆ ダウンロード";
            }, 3000);
        }
    });

    // --- メイン解析処理 (BALLOON修正版) ---
    async function processTjaAndZip(file) {
        log("TJA読み込み中...");
        
        // 文字コード対策
        let text = await readFileAsText(file, 'shift-jis');
        if (!text.includes('TITLE:') && !text.includes('title:') && !text.includes('#NEXTSONG')) {
            log("UTF-8で再試行します...", 'warn');
            text = await readFileAsText(file, 'utf-8');
        }

        const lines = text.split(/\r?\n/);
        
        // --- 1. BALLOONタグの先行全検索 ---
        // 曲の処理前に、ファイル全体からBALLOON定義を確実に取得する
        let globalBalloon = [];
        for (let line of lines) {
            const trim = line.trim();
            // 大文字小文字無視で探す
            if (trim.toUpperCase().startsWith('BALLOON:')) {
                const val = trim.substring(8).trim();
                if (val) {
                    // 全角カンマ、半角カンマ、スペース、読点に対応して分割
                    globalBalloon = val.split(/[,、\s]+/)
                        .map(n => parseInt(n))
                        .filter(n => !isNaN(n)); // 数値変換できるものだけ抽出
                }
                break; // 最初に見つかったBALLOONを採用
            }
        }
        
        if (globalBalloon.length > 0) {
            log(`BALLOON定義を取得: 計 ${globalBalloon.length} 個の風船データ`, 'success');
            // log(`データ: [${globalBalloon.join(', ')}]`);
        } else {
            log(`警告: BALLOONタグが見つかりませんでした。`, 'warn');
        }

        // --- 2. 曲の分割 ---
        let songs = [];
        let currentLines = [];
        let nextSongTag = "";
        
        for (let line of lines) {
            if (line.charCodeAt(0) === 0xFEFF) line = line.substr(1);
            const t = line.trim().toUpperCase();

            if (t.startsWith('#NEXTSONG')) {
                songs.push({ lines: currentLines, tag: nextSongTag });
                currentLines = [];
                nextSongTag = line.trim(); // 次の曲のためにタグを保存
            } else {
                currentLines.push(line);
            }
        }
        songs.push({ lines: currentLines, tag: nextSongTag }); // 最後の曲

        log(`セクション数: ${songs.length} (イントロ含む)`);

        // --- 3. データの分配と出力 ---
        const zip = new JSZip();
        let balloonCursor = 0; // 現在の風船データの位置
        let currentBpm = 0;
        let outputCount = 0;

        // 【イントロ(0番目)の処理】
        // ファイル出力はしないが、ここで使われている風船の数だけカーソルを進める必要がある
        if (songs.length > 0) {
            const intro = songs[0];
            // BPM取得
            intro.lines.forEach(l => {
                if (l.trim().toUpperCase().startsWith('BPM:')) {
                    currentBpm = parseFloat(l.split(':')[1]);
                }
            });
            // 風船消費チェック
            const introNeeded = countNeededBalloons(intro.lines);
            if (introNeeded > 0) {
                balloonCursor += introNeeded;
                log(`イントロで風船を ${introNeeded}個 消費しました。(Next: #${balloonCursor})`, 'warn');
            }
        }

        // 【本編(1番目以降)の処理】
        for (let i = 1; i < songs.length; i++) {
            const song = songs[i];
            const args = parseNextSongArgs(song.tag);
            
            // メタデータ
            const title = args[0] || `Song_${i}`;
            const wave = args[3] || "";
            const genre = args[2] || "";
            const scoreInit = args[4] || "";
            const scoreDiff = args[5] || "";

            // 難易度判別
            let course = "Oni";
            let level = "10";
            if (args.length >= 8) {
                const valA = parseFloat(args[6]);
                if (valA > 4) { // OpenTaiko
                    level = args[6];
                    course = mapCourse(args[7]);
                } else { // TNDE
                    course = mapCourse(args[6]);
                    level = args[7];
                }
            }

            // TJA組み立て
            let out = [];
            out.push(`TITLE:${title}`);
            if (args[1]) out.push(`SUBTITLE:${args[1]}`);
            out.push(`BPM:${currentBpm}`);
            out.push(`WAVE:${wave}`);
            out.push(`OFFSET:0`);
            out.push(`GENRE:${genre}`);
            out.push(`COURSE:${course}`);
            out.push(`LEVEL:${level}`);
            
            // ★風船分配の実行★
            const needed = countNeededBalloons(song.lines);
            if (needed > 0) {
                let assigned = [];
                // 必要な数だけグローバル配列から取り出す
                for (let k = 0; k < needed; k++) {
                    if (balloonCursor < globalBalloon.length) {
                        assigned.push(globalBalloon[balloonCursor]);
                        balloonCursor++;
                    } else {
                        // データ不足時の安全策（5を補填）
                        assigned.push(5);
                        log(`[警告] ${title}: BALLOONデータ不足。自動補完(5)しました。`, 'warn');
                    }
                }
                out.push(`BALLOON:${assigned.join(',')}`);
                log(`[${title}] 風船${needed}個: [${assigned.join(',')}]`, 'success');
            } else {
                out.push(`BALLOON:`);
            }

            out.push(`SCOREINIT:${scoreInit}`);
            out.push(`SCOREDIFF:${scoreDiff}`);
            out.push(`SCOREMODE:2`);
            out.push(``);

            // 譜面データ (EXAM除去)
            song.lines.forEach(l => {
                const t = l.trim().toUpperCase();
                if (!t.startsWith('EXAM') && !t.startsWith('#LEVELHOLD')) {
                    out.push(l);
                }
                // BPM追跡
                if (t.startsWith('#BPMCHANGE')) {
                    const p = l.split(/\s+/);
                    if (p[1]) currentBpm = parseFloat(p[1]);
                }
            });

            // ZIPへ保存
            const safeTitle = title.replace(/[\\/:*?"<>|]/g, "_");
            const folderName = `${i}_${safeTitle}`;
            const folder = zip.folder(folderName);
            
            const diffSuffix = (course === "Edit" || course === "4") ? "_Ura" : "";
            folder.file(`${safeTitle}${diffSuffix}.tja`, out.join('\n'));

            // 音源同梱
            if (wave) {
                const fName = wave.split(/[/\\]/).pop();
                if (filesMap.has(fName)) {
                    folder.file(fName, filesMap.get(fName));
                } else {
                    log(`[警告] 音源ファイル未検出: ${fName}`, 'warn');
                }
            }
            outputCount++;
        }

        if (outputCount > 0) {
            log("ZIP生成中...", 'success');
            const blob = await zip.generateAsync({type:"blob"});
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `${targetTjaFile.name.replace('.tja','')}_split.zip`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            log("ダウンロード完了！");
        } else {
            log("出力するデータがありませんでした。", 'error');
        }
    }

    // --- ユーティリティ ---
    function readFileAsText(file, enc) {
        return new Promise((r, rej) => {
            const reader = new FileReader();
            reader.onload = e => r(e.target.result);
            reader.onerror = rej;
            reader.readAsText(file, enc);
        });
    }

    function parseNextSongArgs(tag) {
        return tag.replace(/^#NEXTSONG\s+/i, '').split(',').map(s => s.trim());
    }

    function mapCourse(id) {
        const i = parseInt(id);
        const map = ["Easy", "Normal", "Hard", "Oni", "Edit"];
        return map[i] || "Oni";
    }

    // 譜面内の 7(風船) と 9(くす玉) をカウント
    function countNeededBalloons(lines) {
        let count = 0;
        let isBody = false;
        for (let line of lines) {
            const t = line.trim().toUpperCase();
            if (t.startsWith('#START')) isBody = true;
            if (t.startsWith('#END')) isBody = false;
            
            if (isBody) {
                const clean = line.split('//')[0]; // コメント除去
                if (clean.trim().startsWith('#')) continue; // 命令無視
                
                for (let c of clean) {
                    if (c === '7' || c === '9') count++;
                }
            }
        }
        return count;
    }
</script>

</body>
</html>
