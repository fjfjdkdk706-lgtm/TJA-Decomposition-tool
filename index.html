<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TJAåˆ†å‰²ãƒ„ãƒ¼ãƒ« (å …ç‰¢ç‰ˆ/Full-Featured)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        /* * ã‚¹ã‚¿ã‚¤ãƒ«å®šç¾©
         * è¦‹ã‚„ã™ã•ã¨ä½¿ã„ã‚„ã™ã•ã‚’ä¸¡ç«‹ã—ãŸãƒ‡ã‚¶ã‚¤ãƒ³ã§ã™ã€‚
         */
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f4f8;
            color: #2d3748;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* ä¸Šå¯„ã›ã«å¤‰æ›´ */
            min-height: 100vh;
            margin: 0;
            padding: 40px 20px;
        }
        .container {
            background: white;
            width: 100%;
            max-width: 700px;
            padding: 2.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        h1 { margin-top: 0; color: #1a202c; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; }
        p.desc { color: #718096; margin-bottom: 2rem; font-size: 0.95rem; line-height: 1.6; }

        /* ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¨ãƒªã‚¢ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .input-group {
            background: #f7fafc;
            border: 2px dashed #cbd5e0;
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            margin-bottom: 1.5rem;
        }
        .input-group:hover { border-color: #3182ce; background: #ebf8ff; }

        input[type="file"] { display: none; }
        
        .btn-select {
            display: inline-block;
            background-color: #4a5568;
            color: #fff;
            padding: 12px 30px;
            font-size: 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }
        .btn-select:hover { background-color: #2d3748; }

        #file-status {
            margin-top: 15px; font-weight: bold; color: #2b6cb0; min-height: 1.5em;
        }

        /* å®Ÿè¡Œãƒœã‚¿ãƒ³ */
        #run-btn {
            width: 100%;
            padding: 16px;
            font-size: 1.1rem;
            font-weight: bold;
            color: white;
            background-color: #3182ce;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            opacity: 0.5;
            pointer-events: none;
        }
        #run-btn.active { opacity: 1; pointer-events: auto; }
        #run-btn:hover { background-color: #2c5282; }

        /* ãƒ­ã‚°ã‚¨ãƒªã‚¢ */
        #log-area {
            margin-top: 2rem;
            background-color: #1a202c;
            color: #a0aec0;
            padding: 1rem;
            border-radius: 6px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
            height: 250px;
            overflow-y: auto;
            white-space: pre-wrap;
            border: 1px solid #4a5568;
        }
        .log-ok { color: #68d391; }
        .log-warn { color: #f6e05e; }
        .log-err { color: #fc8181; font-weight: bold; }
        .log-info { color: #63b3ed; }
    </style>
</head>
<body>

<div class="container">
    <h1>æ®µä½TJA åˆ†å‰²ãƒ»ç”Ÿæˆãƒ„ãƒ¼ãƒ« (å …ç‰¢ç‰ˆ)</h1>
    <p class="desc">
        æ®µä½TJAãŒå…¥ã£ãŸãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚<br>
        ã€ŒBALLOONç®¡ç†æ©Ÿèƒ½ã€ã¨ã€ŒéŸ³å£°åŒæ¢±æ©Ÿèƒ½ã€ã‚’æ­è¼‰ã—ã€å®‰å…¨ã«åˆ†å‰²ã—ã¾ã™ã€‚<br>
        <small>â€»1æ›²ç›®(è¡¨ç´™)ã¯è‡ªå‹•ã§é™¤å¤–ã•ã‚Œã¾ã™ãŒã€BPMã‚„é¢¨èˆ¹ãƒ‡ãƒ¼ã‚¿ã¯æ­£ã—ãå¼•ãç¶™ãŒã‚Œã¾ã™ã€‚</small>
    </p>

    <div class="input-group">
        <label for="folderInput" class="btn-select">ğŸ“‚ ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦èª­ã¿è¾¼ã¿</label>
        <input type="file" id="folderInput" webkitdirectory directory multiple>
        <div id="file-status">ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
    </div>

    <button id="run-btn">åˆ†å‰²å®Ÿè¡Œ ï¼† ZIPãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>

    <div id="log-area">ã“ã“ã«å‡¦ç†ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™...</div>
</div>

<script>
    /**
     * å¤‰æ•°å®šç¾©
     */
    const folderInput = document.getElementById('folderInput');
    const fileStatus = document.getElementById('file-status');
    const runBtn = document.getElementById('run-btn');
    const logArea = document.getElementById('log-area');

    let targetTjaFile = null;
    let filesMap = new Map(); // ãƒ•ã‚¡ã‚¤ãƒ«å -> Fileã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ ã®ãƒãƒƒãƒ—

    /**
     * ãƒ­ã‚°å‡ºåŠ›ç”¨é–¢æ•°
     * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å‡¦ç†çŠ¶æ³ã‚’è©³ã—ãä¼ãˆã¾ã™ã€‚
     */
    function log(msg, type = 'info') {
        const span = document.createElement('div');
        const time = new Date().toLocaleTimeString();
        span.textContent = `[${time}] ${msg}`;
        
        if (type === 'success') span.className = 'log-ok';
        else if (type === 'warn') span.className = 'log-warn';
        else if (type === 'error') span.className = 'log-err';
        else span.className = 'log-info';

        logArea.appendChild(span);
        logArea.scrollTop = logArea.scrollHeight;
    }

    /**
     * 1. ãƒ•ã‚©ãƒ«ãƒ€é¸æŠæ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
     */
    folderInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        filesMap.clear();
        targetTjaFile = null;
        logArea.innerHTML = ''; // ãƒ­ã‚°ã‚¯ãƒªã‚¢

        if (files.length === 0) {
            fileStatus.textContent = "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ";
            return;
        }

        log(`ãƒ•ã‚©ãƒ«ãƒ€å†…ã®ã‚¹ã‚­ãƒ£ãƒ³ã‚’é–‹å§‹: ${files.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«`, 'info');

        let tjaCount = 0;
        files.forEach(f => {
            // ãƒãƒƒãƒ—ã«ä¿å­˜ï¼ˆéŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢ç”¨ï¼‰
            filesMap.set(f.name, f);
            
            if (f.name.toLowerCase().endsWith('.tja')) {
                targetTjaFile = f;
                tjaCount++;
            }
        });

        if (tjaCount === 0) {
            fileStatus.innerHTML = `<span style="color:#e53e3e">ã‚¨ãƒ©ãƒ¼: .tjaãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</span>`;
            log("ã‚¨ãƒ©ãƒ¼: é¸æŠã•ã‚ŒãŸãƒ•ã‚©ãƒ«ãƒ€å†…ã« .tja ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚", 'error');
            runBtn.classList.remove('active');
        } else {
            if (tjaCount > 1) log(`è­¦å‘Š: è¤‡æ•°ã®TJAãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚"${targetTjaFile.name}" ã‚’å„ªå…ˆå‡¦ç†ã—ã¾ã™ã€‚`, 'warn');
            
            fileStatus.innerHTML = `èª­è¾¼å¯èƒ½: <strong>${targetTjaFile.name}</strong>`;
            log(`æº–å‚™å®Œäº†: ãƒ¡ã‚¤ãƒ³ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ -> ${targetTjaFile.name}`, 'success');
            runBtn.classList.add('active');
        }
    });

    /**
     * 2. å®Ÿè¡Œãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
     */
    runBtn.addEventListener('click', async () => {
        if (!targetTjaFile) return;

        // ãƒœã‚¿ãƒ³ã®é€£æ‰“é˜²æ­¢
        runBtn.disabled = true;
        runBtn.textContent = "å‡¦ç†ã‚’å®Ÿè¡Œä¸­...";
        
        try {
            await processTjaAndGenerateZip(targetTjaFile);
            runBtn.textContent = "ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼";
        } catch (err) {
            console.error(err);
            log(`è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${err.message}`, 'error');
            runBtn.textContent = "ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ";
        } finally {
            // 3ç§’å¾Œã«ãƒœã‚¿ãƒ³ã‚’å¾©æ´»
            setTimeout(() => {
                runBtn.disabled = false;
                runBtn.textContent = "åˆ†å‰²å®Ÿè¡Œ ï¼† ZIPãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰";
            }, 3000);
        }
    });

    /**
     * 3. ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯: TJAè§£æã¨ZIPç”Ÿæˆ
     * ã“ã“ã«ã€Œå¤±ã‚ã‚ŒãŸæŠ€è¡“ï¼ˆBalloonç®¡ç†ï¼‰ã€ãŒå«ã¾ã‚Œã¾ã™ã€‚
     */
    async function processTjaAndGenerateZip(file) {
        log("TJAãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ†ã‚­ã‚¹ãƒˆèª­ã¿è¾¼ã¿ä¸­...", 'info');
        
        // æ–‡å­—ã‚³ãƒ¼ãƒ‰å¯¾ç­–: ã¾ãšShift-JISã§è©¦ã™
        let text = await readFileAsText(file, 'shift-jis');
        
        // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒã‚§ãƒƒã‚¯ã§æ–‡å­—åŒ–ã‘åˆ¤å®š
        const hasHeader = text.includes('TITLE:') || text.includes('title:') || text.includes('SIDE:') || text.includes('WAVE:');
        if (!hasHeader) {
            log("Shift-JISã§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ãŸå¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€UTF-8ã§å†è©¦è¡Œã—ã¾ã™...", 'warn');
            text = await readFileAsText(file, 'utf-8');
        }

        const lines = text.split(/\r?\n/);
        const zip = new JSZip();

        // --- ãƒ‡ãƒ¼ã‚¿è§£æãƒ•ã‚§ãƒ¼ã‚º ---

        let songs = [];
        let currentBlock = [];
        let nextSongTag = "";     // æ¬¡ã®æ›²ã®è¨­å®š(#NEXTSONG)
        let globalBalloon = [];   // å…¨ä½“ã®BALLOONãƒ‡ãƒ¼ã‚¿
        let isGlobalHeader = true;

        for (let line of lines) {
            // BOM(Byte Order Mark)ã®å‰Šé™¤
            if (line.charCodeAt(0) === 0xFEFF) line = line.substr(1);
            
            const trimLine = line.trim();
            const upperLine = trimLine.toUpperCase();

            // ã‚°ãƒ­ãƒ¼ãƒãƒ«é ˜åŸŸã®BALLOONæƒ…å ±ã‚’å–å¾—
            if (isGlobalHeader && upperLine.startsWith('BALLOON:')) {
                const val = trimLine.substring(8).trim();
                if (val) {
                    // å…¨è§’ã‚«ãƒ³ãƒç­‰ã‚‚è€ƒæ…®ã—ã¦é…åˆ—åŒ–
                    globalBalloon = val.split(/[,ã€]/).map(n => parseInt(n.trim()) || 0);
                    log(`ã‚°ãƒ­ãƒ¼ãƒãƒ«BALLOONå®šç¾©ã‚’ç™ºè¦‹: ${globalBalloon.length}å€‹`, 'info');
                }
            }

            // #START ä»¥é™ã¯å„æ›²ã®ãƒ‡ãƒ¼ã‚¿ãªã®ã§ã‚°ãƒ­ãƒ¼ãƒãƒ«çµ‚äº†
            if (upperLine.startsWith('#START')) {
                isGlobalHeader = false;
            }

            // #NEXTSONG ã§æ›²ã‚’åˆ†å‰²
            if (upperLine.startsWith('#NEXTSONG')) {
                // ã“ã“ã¾ã§ã®å†…å®¹ã‚’1æ›²ã¨ã—ã¦ç™»éŒ²
                songs.push({ lines: currentBlock, tag: nextSongTag });
                currentBlock = [];
                nextSongTag = trimLine; // æ¬¡ã®æ›²ã®ã‚¿ã‚°ã¨ã—ã¦ä¿å­˜
                isGlobalHeader = false;
            } else {
                currentBlock.push(line);
            }
        }
        // æœ€å¾Œã®æ›²ã‚’ç™»éŒ²
        songs.push({ lines: currentBlock, tag: nextSongTag });

        log(`${songs.length} ã¤ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆè¡¨ç´™å«ã‚€ï¼‰ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚`, 'success');

        // --- å‡ºåŠ›ãƒ•ã‚§ãƒ¼ã‚º ---

        let balloonIndex = 0; // ç¾åœ¨ã®é¢¨èˆ¹é…åˆ—ã®å‚ç…§ä½ç½®
        let currentBpm = 0;   // BPMå¼•ãç¶™ãç”¨
        let processedCount = 0;

        // ã€é‡è¦ã€‘0ç•ªç›®ï¼ˆè¡¨ç´™/ã‚¤ãƒ³ãƒˆãƒ­ï¼‰ã®å‡¦ç†
        // ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›ã¯ã—ã¾ã›ã‚“ãŒã€ã€Œé¢¨èˆ¹ã®æ¶ˆè²»ã€ã¨ã€ŒBPMã®å–å¾—ã€ã‚’è¡Œã„ã¾ã™ã€‚
        if (songs.length > 0) {
            const intro = songs[0];
            
            // BPMå–å¾—
            intro.lines.forEach(l => {
                if(l.trim().toUpperCase().startsWith('BPM:')) {
                    currentBpm = parseFloat(l.split(':')[1]);
                }
            });

            // ã‚¤ãƒ³ãƒˆãƒ­ã§ã®é¢¨èˆ¹æ¶ˆè²»æ•°ã‚’è¨ˆç®—
            const introNeeded = countNeededBalloons(intro.lines);
            if (introNeeded > 0) {
                balloonIndex += introNeeded;
                log(`ã‚¤ãƒ³ãƒˆãƒ­å‡¦ç†: é¢¨èˆ¹ã‚’ ${introNeeded}å€‹ æ¶ˆè²»ã—ã¾ã—ãŸã€‚(Next Index: ${balloonIndex})`, 'info');
            } else {
                log(`ã‚¤ãƒ³ãƒˆãƒ­å‡¦ç†: é¢¨èˆ¹ã®æ¶ˆè²»ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`, 'info');
            }
        }

        // 1ç•ªç›®ä»¥é™ï¼ˆå®Ÿéš›ã®èª²é¡Œæ›²ï¼‰ã®ãƒ«ãƒ¼ãƒ—å‡¦ç†
        for (let i = 1; i < songs.length; i++) {
            const song = songs[i];
            
            // #NEXTSONGè¡Œã®è§£æ
            // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: Title, Sub, Genre, Wave, ScoreInit, ScoreDiff, (Level/Course)...
            const args = parseNextSongArgs(song.tag);
            
            const title = args[0] || `Song_${i}`;
            const subtitle = args[1] || "";
            const genre = args[2] || "";
            const waveFile = args[3] || "";
            const scoreInit = args[4] || "";
            const scoreDiff = args[5] || "";

            // é›£æ˜“åº¦ã¨ã‚³ãƒ¼ã‚¹ã®è‡ªå‹•åˆ¤åˆ¥ãƒ­ã‚¸ãƒƒã‚¯
            let levelStr = "10";
            let courseStr = "Oni";
            
            // å¼•æ•°ãŒè¶³ã‚Šã¦ã„ã‚‹å ´åˆã®ã¿åˆ¤å®š
            if (args.length >= 8) {
                const valA = parseFloat(args[6]);
                // OpenTaikoå½¢å¼ (Level, Course) ã‹ TNDEå½¢å¼ (Course, Level) ã‹
                // ã‚³ãƒ¼ã‚¹IDã¯0~4ãªã®ã§ã€5ä»¥ä¸Šãªã‚‰ãƒ¬ãƒ™ãƒ«ã¨ã¿ãªã™
                if (valA > 4) {
                    levelStr = args[6];
                    courseStr = mapCourseId(args[7]);
                } else {
                    courseStr = mapCourseId(args[6]);
                    levelStr = args[7];
                }
            }

            // TJAå‡ºåŠ›ãƒãƒƒãƒ•ã‚¡
            let outputLines = [];
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼æ›¸ãå‡ºã—
            outputLines.push(`TITLE:${title}`);
            if(subtitle) outputLines.push(`SUBTITLE:${subtitle}`);
            outputLines.push(`BPM:${currentBpm}`); // å¼•ãç¶™ã„ã BPM
            outputLines.push(`WAVE:${waveFile}`);
            outputLines.push(`OFFSET:0`);
            outputLines.push(`GENRE:${genre}`);
            outputLines.push(`COURSE:${courseStr}`);
            outputLines.push(`LEVEL:${levelStr}`);
            
            // ã€æœ€é‡è¦ã€‘é¢¨èˆ¹ãƒ‡ãƒ¼ã‚¿ã®åˆ†é…ãƒ­ã‚¸ãƒƒã‚¯
            const needed = countNeededBalloons(song.lines);
            if (needed > 0) {
                // å®‰å…¨è£…ç½®: é…åˆ—å¤–å‚ç…§ã‚’é˜²ã
                let myBalloons = [];
                for(let b=0; b<needed; b++) {
                    if (balloonIndex + b < globalBalloon.length) {
                        myBalloons.push(globalBalloon[balloonIndex + b]);
                    } else {
                        // ãƒ‡ãƒ¼ã‚¿ä¸è¶³æ™‚ã¯å®‰å…¨ç­–ã¨ã—ã¦ã€Œ5ã€ã‚’è£œå¡«
                        myBalloons.push(5);
                        log(`[è­¦å‘Š] ${title}: BALLOONãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚è‡ªå‹•ã§'5'ã‚’è£œå¡«ã—ã¾ã—ãŸã€‚`, 'warn');
                    }
                }
                outputLines.push(`BALLOON:${myBalloons.join(',')}`);
                balloonIndex += needed;
            } else {
                outputLines.push(`BALLOON:`);
            }

            outputLines.push(`SCOREINIT:${scoreInit}`);
            outputLines.push(`SCOREDIFF:${scoreDiff}`);
            outputLines.push(`SCOREMODE:2`);
            outputLines.push(``); // ç©ºè¡Œ

            // è­œé¢ãƒ‡ãƒ¼ã‚¿æœ¬ä½“ã®æ›¸ãå‡ºã—
            song.lines.forEach(l => {
                const t = l.trim().toUpperCase();
                // EXAM, LEVELHOLDã®é™¤å»
                if (t.startsWith('EXAM') || t.startsWith('#LEVELHOLD')) return;
                
                outputLines.push(l);

                // BPMè¿½è·¡: æ¬¡ã®æ›²ã®ãŸã‚ã«æœ€çµ‚çš„ãªBPMã‚’è¦šãˆã¦ãŠã
                if (t.startsWith('#BPMCHANGE')) {
                    const parts = l.trim().split(/\s+/);
                    if (parts[1]) currentBpm = parseFloat(parts[1]);
                }
            });

            // --- ZIPãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®è¿½åŠ  ---
            
            // ãƒ•ã‚¡ã‚¤ãƒ«åã«ä½¿ãˆãªã„æ–‡å­—ã‚’ç½®æ›
            const safeTitle = title.replace(/[\\/:*?"<>|]/g, "_");
            // ãƒ•ã‚©ãƒ«ãƒ€å: 1_æ›²å, 2_æ›²å...
            const folderName = `${i}_${safeTitle}`;
            const songFolder = zip.folder(folderName);
            
            // è£è­œé¢ãªã©ã®å ´åˆã®ãƒ•ã‚¡ã‚¤ãƒ«åèª¿æ•´
            const diffSuffix = (courseStr === "Edit" || courseStr === "4") ? "_Ura" : "";
            songFolder.file(`${safeTitle}${diffSuffix}.tja`, outputLines.join("\n"));

            // éŸ³æºãƒ•ã‚¡ã‚¤ãƒ«ã®åŒæ¢±
            if (waveFile) {
                // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ‘ã‚¹ãŒå«ã¾ã‚Œã¦ã„ã¦ã‚‚ãƒ•ã‚¡ã‚¤ãƒ«åã ã‘æŠ½å‡º
                const targetName = waveFile.split(/[/\\]/).pop();
                
                if (filesMap.has(targetName)) {
                    songFolder.file(targetName, filesMap.get(targetName));
                    log(`[æˆåŠŸ] ${title}: éŸ³æºåŒæ¢± -> ${targetName}`, 'success');
                } else {
                    log(`[æ³¨æ„] ${title}: éŸ³æºãƒ•ã‚¡ã‚¤ãƒ« "${targetName}" ãŒãƒ•ã‚©ãƒ«ãƒ€å†…ã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`, 'warn');
                }
            }
            processedCount++;
        }

        if (processedCount === 0) {
            log("å‡ºåŠ›ã™ã¹ãæ›²ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚", 'error');
            return;
        }

        log("ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’åœ§ç¸®ç”Ÿæˆä¸­...", 'info');
        const content = await zip.generateAsync({type:"blob"});
        
        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒˆãƒªã‚¬ãƒ¼
        const link = document.createElement("a");
        link.href = URL.createObjectURL(content);
        const baseName = targetTjaFile.name.replace(/\.[^/.]+$/, "");
        link.download = `${baseName}_split.zip`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        log("å‡¦ç†å®Œäº†ï¼ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚", 'success');
    }

    // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ---

    function readFileAsText(file, encoding) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = (e) => reject(e);
            reader.readAsText(file, encoding);
        });
    }

    function parseNextSongArgs(tag) {
        // #NEXTSONG é™¤å»
        const content = tag.replace(/^#NEXTSONG\s+/i, '');
        // ã‚«ãƒ³ãƒã§åŒºåˆ‡ã£ã¦ãƒˆãƒªãƒ 
        return content.split(',').map(s => s.trim());
    }

    function mapCourseId(id) {
        const n = parseInt(id);
        if (n === 0) return "Easy";
        if (n === 1) return "Normal";
        if (n === 2) return "Hard";
        if (n === 3) return "Oni";
        if (n === 4) return "Edit";
        return "Oni"; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
    }

    /**
     * è­œé¢ãƒ‡ãƒ¼ã‚¿å†…ã®é¢¨èˆ¹(7)ã¨ãã™ç‰(9)ã®å€‹æ•°ã‚’æ•°ãˆã‚‹é‡è¦é–¢æ•°
     */
    function countNeededBalloons(lines) {
        let count = 0;
        let isBody = false;

        for (let line of lines) {
            const t = line.trim().toUpperCase();
            if (t.startsWith('#START')) isBody = true;
            if (t.startsWith('#END')) isBody = false;

            if (isBody) {
                // ã‚³ãƒ¡ãƒ³ãƒˆé™¤å» (//ä»¥é™ã¯ç„¡è¦–)
                let cleanLine = line.split('//')[0];
                
                // å‘½ä»¤(#)ã®è¡Œã¯éŸ³ç¬¦ã§ã¯ãªã„ã®ã§ç„¡è¦–
                if (cleanLine.trim().startsWith('#')) continue;

                for (let char of cleanLine) {
                    if (char === '7' || char === '9') {
                        count++;
                    }
                }
            }
        }
        return count;
    }
</script>

</body>
</html>
