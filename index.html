<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ®µä½ãƒ•ã‚©ãƒ«ãƒ€åˆ†å‰²ãƒ„ãƒ¼ãƒ«</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            background-color: #f4f6f8;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }
        .card {
            background: white;
            width: 100%;
            max-width: 600px;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            text-align: center;
        }
        h1 {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: #2d3748;
        }

        /* 1. ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .file-select-wrapper {
            margin-bottom: 1.5rem;
        }
        input[type="file"] {
            display: none; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ•ã‚©ãƒ¼ãƒ ã¯éš ã™ */
        }
        .btn-select {
            display: inline-block;
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: bold;
            color: #fff;
            background-color: #4a5568;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-select:hover {
            background-color: #2d3748;
        }

        /* 2. é¸æŠã—ãŸãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã®è¡¨ç¤ºå ´æ‰€ */
        #file-info-area {
            background-color: #edf2f7;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1.5rem;
            color: #4a5568;
            font-size: 0.9rem;
            min-height: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        .status-ready { color: #38a169; font-weight: bold; }
        .status-error { color: #e53e3e; font-weight: bold; }

        /* 3. å®Ÿè¡Œãƒœã‚¿ãƒ³ */
        #run-btn {
            width: 100%;
            padding: 15px;
            font-size: 1.1rem;
            font-weight: bold;
            color: white;
            background-color: #3182ce;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
            opacity: 0.5;
            pointer-events: none; /* æœ€åˆã¯æŠ¼ã›ãªã„ */
        }
        #run-btn.active {
            opacity: 1;
            pointer-events: auto;
        }
        #run-btn:hover {
            background-color: #2b6cb0;
        }

        /* ãƒ­ã‚°ã‚¨ãƒªã‚¢ */
        #log {
            margin-top: 20px;
            font-size: 0.8rem;
            color: #718096;
            text-align: left;
            white-space: pre-wrap;
            max-height: 150px;
            overflow-y: auto;
            border-top: 1px solid #e2e8f0;
            padding-top: 10px;
        }
    </style>
</head>
<body>

<div class="card">
    <h1>æ®µä½ãƒ•ã‚©ãƒ«ãƒ€åˆ†å‰²ãƒ»ç”Ÿæˆãƒ„ãƒ¼ãƒ«</h1>

    <div class="file-select-wrapper">
        <label for="folderInput" class="btn-select">ğŸ“‚ æ®µä½ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ</label>
        <input type="file" id="folderInput" webkitdirectory directory multiple>
    </div>

    <div id="file-info-area">
        ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“
    </div>

    <button id="run-btn">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†è§£ã—ã¦ãƒ•ã‚©ãƒ«ãƒ€ã‚’ç”Ÿæˆ (ZIP)</button>

    <div id="log"></div>
</div>

<script>
    // è¦ç´ ã®å–å¾—
    const folderInput = document.getElementById('folderInput');
    const fileInfoArea = document.getElementById('file-info-area');
    const runBtn = document.getElementById('run-btn');
    const logDiv = document.getElementById('log');

    let selectedFiles = [];
    let targetTjaFile = null;
    let filesMap = new Map();

    // ãƒ­ã‚°æ©Ÿèƒ½
    function log(msg) {
        logDiv.textContent = `> ${msg}\n` + logDiv.textContent;
    }

    // --- 1. ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®å‡¦ç† ---
    folderInput.addEventListener('change', (e) => {
        selectedFiles = Array.from(e.target.files);
        filesMap.clear();
        targetTjaFile = null;
        
        if (selectedFiles.length === 0) {
            fileInfoArea.textContent = "ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“";
            runBtn.classList.remove('active');
            return;
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã¨TJAæ¢ç´¢
        let tjaCount = 0;
        selectedFiles.forEach(file => {
            filesMap.set(file.name, file); // ãƒ•ã‚¡ã‚¤ãƒ«åã§ãƒãƒƒãƒ—åŒ–
            if (file.name.toLowerCase().endsWith('.tja')) {
                targetTjaFile = file;
                tjaCount++;
            }
        });

        // UIæ›´æ–°
        if (targetTjaFile) {
            fileInfoArea.innerHTML = `
                <div>é¸æŠãƒ•ã‚©ãƒ«ãƒ€å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«æ•°: <strong>${selectedFiles.length}</strong></div>
                <div class="status-ready">æ¤œå‡ºTJA: ${targetTjaFile.name}</div>
            `;
            runBtn.classList.add('active'); // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            log(`æº–å‚™å®Œäº†: ${targetTjaFile.name} ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚`);
        } else {
            fileInfoArea.innerHTML = `
                <div>ãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${selectedFiles.length}</div>
                <div class="status-error">ã‚¨ãƒ©ãƒ¼: .tjaãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>
            `;
            runBtn.classList.remove('active');
            log("ã‚¨ãƒ©ãƒ¼: é¸æŠã•ã‚ŒãŸãƒ•ã‚©ãƒ«ãƒ€å†…ã« .tja ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
        }
    });

    // --- 2. å®Ÿè¡Œãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã®å‡¦ç† ---
    runBtn.addEventListener('click', async () => {
        if (!targetTjaFile) return;

        runBtn.disabled = true;
        runBtn.textContent = "å‡¦ç†ä¸­...";
        log("å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™...");

        try {
            await processTjaAndZip(targetTjaFile, filesMap);
            runBtn.textContent = "å®Œäº†ï¼";
        } catch (err) {
            console.error(err);
            log(`ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ: ${err.message}`);
            runBtn.textContent = "ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ";
        } finally {
            setTimeout(() => {
                runBtn.disabled = false;
                runBtn.textContent = "ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†è§£ã—ã¦ãƒ•ã‚©ãƒ«ãƒ€ã‚’ç”Ÿæˆ (ZIP)";
            }, 3000);
        }
    });

    // --- 3. ãƒ­ã‚¸ãƒƒã‚¯æœ¬ä½“ (TJAè§£æãƒ»åˆ†å‰²ãƒ»ZIPåŒ–) ---
    async function processTjaAndZip(tjaFile, filesMap) {
        // æ–‡å­—ã‚³ãƒ¼ãƒ‰èª­ã¿è¾¼ã¿ (Shift-JISå„ªå…ˆ)
        let text = await readFileAsText(tjaFile, 'shift-jis');
        // æ–‡å­—åŒ–ã‘åˆ¤å®šï¼ˆTITLEãªã©ãŒèª­ã‚ãªã„å ´åˆUTF-8ã§å†è©¦è¡Œï¼‰
        if (!text.includes('TITLE:') && !text.includes('title:') && !text.includes('#NEXTSONG')) {
            log("UTF-8ã§å†èª­ã¿è¾¼ã¿ã—ã¾ã™...");
            text = await readFileAsText(tjaFile, 'utf-8');
        }

        const lines = text.split(/\r?\n/);
        const zip = new JSZip();

        // æ›²ã®åˆ†å‰²
        let songs = [];
        let currentSong = { lines: [], nextSongTag: "" };
        let balloonData = [];
        let isGlobalSection = true;

        for (let line of lines) {
            if (line.charCodeAt(0) === 0xFEFF) line = line.substr(1); // BOMå‰Šé™¤
            const trimLine = line.trim();
            const upperLine = trimLine.toUpperCase();

            // ã‚°ãƒ­ãƒ¼ãƒãƒ«é ˜åŸŸã®BALLOONå–å¾—
            if (isGlobalSection && upperLine.startsWith('BALLOON:')) {
                const val = trimLine.substring(8).trim();
                if(val) balloonData = val.split(/[,ã€]/).map(n => parseInt(n.trim()) || 0);
            }
            if (upperLine.startsWith('#START')) isGlobalSection = false;

            // #NEXTSONGã§åˆ†å‰²
            if (upperLine.startsWith('#NEXTSONG')) {
                songs.push(currentSong);
                currentSong = { lines: [], nextSongTag: trimLine };
                isGlobalSection = false;
            } else {
                currentSong.lines.push(line);
            }
        }
        if (currentSong.lines.length > 0) songs.push(currentSong);

        // --- ã‚¤ãƒ³ãƒˆãƒ­(1æ›²ç›®)ã®å‡¦ç† ---
        // ã‚¤ãƒ³ãƒˆãƒ­ã¯å‡ºåŠ›ã—ãªã„ãŒã€æ¶ˆè²»ã•ã‚ŒãŸé¢¨èˆ¹ã¨BPMæƒ…å ±ã¯å¼•ãç¶™ã
        let balloonIndex = 0;
        let currentBpm = 0;

        if (songs.length > 0) {
            const intro = songs[0];
            // åˆæœŸBPMå–å¾—
            intro.lines.forEach(l => {
                if (l.trim().toUpperCase().startsWith('BPM:')) currentBpm = parseFloat(l.split(':')[1]);
            });
            // é¢¨èˆ¹æ¶ˆè²»
            balloonIndex += countBalloons(intro.lines);
        }

        // --- 2æ›²ç›®ä»¥é™ã®å‡ºåŠ› ---
        let outputCount = 0;

        for (let i = 1; i < songs.length; i++) {
            const song = songs[i];
            
            // #NEXTSONGè§£æ [Title, Sub, Genre, Wave, Init, Diff, Level, Course]
            const args = parseNextSong(song.nextSongTag);
            
            let songTitle = args[0] || `Song_${i}`;
            let subTitle = args[1] || "";
            let genre = args[2] || "";
            let waveFileName = args[3] || "";
            let scoreInit = args[4] || "";
            let scoreDiff = args[5] || "";
            
            // é›£æ˜“åº¦ãƒ»ã‚³ãƒ¼ã‚¹åˆ¤åˆ¥ (OpenTaiko vs TNDE)
            let courseStr = "Oni";
            let levelStr = "10";
            if (args.length >= 8) {
                const valA = parseFloat(args[6]);
                if (valA > 4) { // OpenTaiko
                    levelStr = args[6];
                    courseStr = mapCourseId(args[7]);
                } else { // TNDE
                    courseStr = mapCourseId(args[6]);
                    levelStr = args[7];
                }
            }

            // å‡ºåŠ›ç”¨TJAã®æ§‹ç¯‰
            let outputLines = [];
            outputLines.push(`TITLE:${songTitle}`);
            if(subTitle) outputLines.push(`SUBTITLE:${subTitle}`);
            outputLines.push(`BPM:${currentBpm}`); // å‰ã®æ›²ã®BPMã‚’å¼•ãç¶™ã
            outputLines.push(`WAVE:${waveFileName}`);
            outputLines.push(`OFFSET:0`);
            outputLines.push(`GENRE:${genre}`);
            outputLines.push(`COURSE:${courseStr}`);
            outputLines.push(`LEVEL:${levelStr}`);
            outputLines.push(`SCOREINIT:${scoreInit}`);
            outputLines.push(`SCOREDIFF:${scoreDiff}`);
            outputLines.push(`SCOREMODE:2`); // çœŸæ‰“

            // é¢¨èˆ¹å‰²ã‚Šå½“ã¦
            const needBalloons = countBalloons(song.lines);
            if (needBalloons > 0) {
                const myBalloons = balloonData.slice(balloonIndex, balloonIndex + needBalloons);
                outputLines.push(`BALLOON:${myBalloons.join(',')}`);
                balloonIndex += needBalloons;
            } else {
                outputLines.push(`BALLOON:`);
            }
            outputLines.push('');

            // è­œé¢ãƒ‡ãƒ¼ã‚¿ (EXAMå‰Šé™¤)
            song.lines.forEach(l => {
                const t = l.trim().toUpperCase();
                if (!t.startsWith('EXAM') && !t.startsWith('#LEVELHOLD')) {
                    outputLines.push(l);
                }
                // BPMè¿½è·¡
                if (t.startsWith('#BPMCHANGE')) {
                    const parts = t.split(/\s+/);
                    if(parts[1]) currentBpm = parseFloat(parts[1]);
                }
            });

            // ZIPæ ¼ç´
            const safeTitle = songTitle.replace(/[\\/*?:"<>|]/g, "_");
            const folderName = `${i}_${safeTitle}`; // ãƒ•ã‚©ãƒ«ãƒ€å
            const folder = zip.folder(folderName);

            // TJAæ›¸ãå‡ºã—
            const safeDiff = (courseStr === "Edit" || courseStr === "4") ? "_Ura" : "";
            folder.file(`${safeTitle}${safeDiff}.tja`, outputLines.join("\n"));

            // éŸ³å£°æ›¸ãå‡ºã—
            if (waveFileName) {
                const targetName = waveFileName.split(/[/\\]/).pop(); // ãƒ‘ã‚¹é™¤å»
                if (filesMap.has(targetName)) {
                    folder.file(targetName, filesMap.get(targetName));
                    log(`[${i}] éŸ³æºåŒæ¢±: ${targetName}`);
                } else {
                    log(`[${i}] è­¦å‘Š: éŸ³æºãªã— (${targetName})`);
                }
            }
            outputCount++;
        }

        // ZIPãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å‡¦ç†
        log("ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆä¸­...");
        const blob = await zip.generateAsync({type:"blob"});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `${tjaFile.name.replace('.tja','')}_split.zip`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        log("ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼");
    }

    // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
    function readFileAsText(file, encoding) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = e => resolve(e.target.result);
            reader.onerror = e => reject(e);
            reader.readAsText(file, encoding);
        });
    }

    function parseNextSong(tag) {
        return tag.replace(/^#NEXTSONG\s+/i, '').split(',').map(s => s.trim());
    }

    function mapCourseId(id) {
        const i = parseInt(id);
        if (i === 0) return "Easy";
        if (i === 1) return "Normal";
        if (i === 2) return "Hard";
        if (i === 3) return "Oni";
        if (i === 4) return "Edit";
        return "Oni";
    }

    function countBalloons(lines) {
        let count = 0;
        let isBody = false;
        for (let line of lines) {
            const t = line.trim().toUpperCase();
            if (t.startsWith('#START')) isBody = true;
            if (t.startsWith('#END')) isBody = false;
            if (isBody) {
                let clean = line.split('//')[0];
                if (clean.trim().startsWith('#')) continue;
                for (let c of clean) {
                    if (c === '7' || c === '9') count++;
                }
            }
        }
        return count;
    }
</script>

</body>
</html>
