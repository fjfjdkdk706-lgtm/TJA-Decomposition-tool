<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>æ®µä½TJAåˆ†å‰²ãƒ„ãƒ¼ãƒ« (å¼·åˆ¶ã‚«ã‚¦ãƒ³ãƒˆç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body { font-family: "Helvetica Neue", sans-serif; background: #263238; color: #eceff1; padding: 20px; display: flex; justify-content: center; }
        .card { background: #37474f; padding: 2rem; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); width: 100%; max-width: 800px; }
        h1 { margin-top: 0; color: #80cbc4; border-bottom: 2px solid #546e7a; padding-bottom: 15px; font-size: 1.5rem; }
        
        .upload-area { 
            border: 3px dashed #78909c; padding: 40px; text-align: center; margin-bottom: 20px; 
            border-radius: 8px; background: #455a64; cursor: pointer; transition: 0.2s; 
        }
        .upload-area:hover { background: #546e7a; border-color: #80cbc4; }
        .upload-area p { margin: 0; font-size: 1.1rem; color: #b0bec5; }
        
        button { 
            width: 100%; padding: 18px; background: #00897b; color: white; font-weight: bold; 
            border: none; border-radius: 6px; cursor: pointer; font-size: 1.2rem; 
            opacity: 0.5; pointer-events: none; transition: 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        button.active { opacity: 1; pointer-events: auto; }
        button:hover { background: #00796b; transform: translateY(-2px); }

        #log-area { 
            margin-top: 25px; background: #212121; color: #cfd8dc; padding: 20px; 
            height: 400px; overflow-y: auto; font-family: "Consolas", monospace; 
            font-size: 0.95rem; border-radius: 6px; border: 1px solid #424242; 
            white-space: pre-wrap; line-height: 1.5; 
        }
        
        .log-h { color: #80cbc4; font-weight: bold; margin-top: 10px; display: block; }
        .log-w { color: #ffe082; }
        .log-e { color: #ff8a80; font-weight: bold; }
        .log-num { color: #fff; background: #00695c; padding: 0 5px; border-radius: 3px; }
        .log-zero { color: #b0bec5; opacity: 0.7; }
    </style>
</head>
<body>

<div class="card">
    <h1>æ®µä½TJA åˆ†å‰²ãƒ»ç”Ÿæˆãƒ„ãƒ¼ãƒ« (å¼·åˆ¶èªè­˜ãƒ¢ãƒ¼ãƒ‰)</h1>
    
    <div class="upload-area" id="dropZone" onclick="document.getElementById('fileInput').click()">
        <p>ğŸ“‚ ã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ</p>
        <input type="file" id="fileInput" webkitdirectory directory multiple style="display:none">
        <div id="status-text" style="margin-top:10px; font-weight:bold; color:#80cbc4;"></div>
    </div>

    <button id="runBtn">å®Ÿè¡Œ ï¼† ZIPãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
    <div id="log-area">å¾…æ©Ÿä¸­...</div>
</div>

<script>
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const statusText = document.getElementById('status-text');
    const runBtn = document.getElementById('runBtn');
    const logArea = document.getElementById('log-area');

    let targetFile = null;
    let fileMap = new Map();

    // ãƒ­ã‚°å‡ºåŠ›
    function log(msg, type='') {
        const span = document.createElement('div');
        span.innerHTML = msg; // HTMLã‚¿ã‚°è¨±å¯
        if(type==='head') span.className = 'log-h';
        if(type==='warn') span.className = 'log-w';
        if(type==='err') span.className = 'log-e';
        logArea.appendChild(span);
        logArea.scrollTop = logArea.scrollHeight;
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå‡¦ç†
    fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
    dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.style.background = '#546e7a'; });
    dropZone.addEventListener('dragleave', e => { e.preventDefault(); dropZone.style.background = '#455a64'; });
    dropZone.addEventListener('drop', e => {
        e.preventDefault();
        dropZone.style.background = '#455a64';
        handleFiles(e.dataTransfer.files); // ç°¡æ˜“å®Ÿè£…
    });

    function handleFiles(files) {
        fileMap.clear();
        targetFile = null;
        logArea.innerHTML = '';
        const fList = Array.from(files);
        
        if(fList.length === 0) return;

        let tjaFound = false;
        fList.forEach(f => {
            fileMap.set(f.name, f);
            if(f.name.toLowerCase().endsWith('.tja')) {
                targetFile = f;
                tjaFound = true;
            }
        });

        if(tjaFound) {
            statusText.textContent = `èª­è¾¼: ${targetFile.name}`;
            log(`[æº–å‚™] ${targetFile.name} ã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¨ã—ã¦ãƒ­ãƒƒã‚¯ã—ã¾ã—ãŸã€‚`, 'head');
            runBtn.classList.add('active');
        } else {
            statusText.textContent = "TJAãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";
            log("ã‚¨ãƒ©ãƒ¼: ãƒ•ã‚©ãƒ«ãƒ€å†…ã« .tja ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚", 'err');
        }
    }

    // å®Ÿè¡Œå‡¦ç†
    runBtn.addEventListener('click', async () => {
        if(!targetFile) return;
        runBtn.disabled = true;
        runBtn.textContent = "è§£æä¸­...";
        
        try {
            await processDanUi();
            runBtn.textContent = "å®Œäº†ï¼";
        } catch(e) {
            console.error(e);
            log(`è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'err');
            runBtn.textContent = "ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ";
        }
        
        setTimeout(() => {
            runBtn.disabled = false;
            runBtn.textContent = "å®Ÿè¡Œ ï¼† ZIPãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰";
        }, 3000);
    });

    // ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯
    async function processDanUi() {
        // 1. èª­ã¿è¾¼ã¿ (SJIS -> UTF8ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯)
        let text = await readFile(targetFile, 'shift-jis');
        if(!text.includes('TITLE:') && !text.includes('#NEXTSONG')) {
            log("Shift-JISèª­è¾¼å¤±æ•—ã€UTF-8ã§å†è©¦è¡Œ...", 'warn');
            text = await readFile(targetFile, 'utf-8');
        }

        const lines = text.split(/\r?\n/);
        const zip = new JSZip();

        // 2. BALLOONå…¨å›å
        let globalBalloonPool = [];
        let tempStr = "";
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ã®ã©ã“ã«ã‚ã‚ã†ã¨ã€BALLOON:ã‚’è¦‹ã¤ã‘ãŸã‚‰æ•°å€¤ã‚’ã‚‚ãå–ã‚‹
        for(let line of lines) {
            let t = line.trim();
            if(t.toUpperCase().startsWith('BALLOON:')) {
                let val = t.substring(8).trim();
                // è¤‡æ•°è¡Œã«ã¾ãŸãŒã‚‹ã‚±ãƒ¼ã‚¹ã‚‚è€ƒæ…®ã—ã¦ã€ã¨ã‚Šã‚ãˆãšè¦‹ã¤ã‘ãŸã‚‰ç¢ºä¿
                if(val) tempStr += val + ","; 
            }
        }
        
        if(tempStr) {
            // å…¨è§’ã‚«ãƒ³ãƒã‚„ç©ºç™½ã‚’é™¤å»ã—ã¦é…åˆ—åŒ–
            globalBalloonPool = tempStr.split(/[,ã€\s]+/)
                .map(n => parseInt(n))
                .filter(n => !isNaN(n));
            log(`[å…¨ä½“å®šç¾©] BALLOONãƒ—ãƒ¼ãƒ«: è¨ˆ<span class="log-num">${globalBalloonPool.length}å€‹</span>ã®æ•°å€¤ã‚’ç¢ºä¿`, 'head');
        } else {
            log(`[è­¦å‘Š] BALLOONå®šç¾©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å…¨ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤(5)ã«ãªã‚Šã¾ã™ã€‚`, 'warn');
        }

        // 3. æ›²ã”ã¨ã®ãƒ–ãƒ­ãƒƒã‚¯åŒ–
        let sections = [];
        let buffer = [];
        let nextTag = "";

        // è¡Œé ­ã®BOMå‰Šé™¤
        if(lines.length > 0 && lines[0].charCodeAt(0) === 0xFEFF) {
            lines[0] = lines[0].substr(1);
        }

        for(let line of lines) {
            let t = line.trim().toUpperCase();
            if(t.startsWith('#NEXTSONG')) {
                sections.push({ lines: buffer, tag: nextTag });
                buffer = [];
                nextTag = line.trim();
            } else {
                buffer.push(line);
            }
        }
        sections.push({ lines: buffer, tag: nextTag });

        // 4. è§£æã¨åˆ†é…
        let balloonCursor = 0; // ãƒ—ãƒ¼ãƒ«ã®ã©ã“ã¾ã§é…ã£ãŸã‹
        let currentBpm = 0;
        let processedCount = 0;

        // --- 0ç•ªç›® (ã‚¤ãƒ³ãƒˆãƒ­/è¡¨ç´™) ---
        // å‡ºåŠ›ã¯ã—ãªã„ãŒã€ã“ã“ã§ä½¿ã‚ã‚Œã¦ã„ã‚‹é¢¨èˆ¹ã¯ã€Œæ¶ˆè²»ã€æ‰±ã„ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
        if(sections.length > 0) {
            const intro = sections[0];
            // BPMå–å¾—
            intro.lines.forEach(l => {
                if(l.trim().toUpperCase().startsWith('BPM:')) currentBpm = parseFloat(l.split(':')[1]);
            });
            
            // å¼·åˆ¶ã‚«ã‚¦ãƒ³ãƒˆå®Ÿè¡Œ
            const introUsed = count79_Force(intro.lines);
            if(introUsed > 0) {
                balloonCursor += introUsed;
                log(`[Intro] è¡¨ç´™éƒ¨åˆ†ã§é¢¨èˆ¹ã‚’ <span class="log-num">${introUsed}å€‹</span> æ¶ˆè²»ã—ã¾ã—ãŸ (Skip)`, 'warn');
            }
        }

        // --- 1ç•ªç›®ä»¥é™ (èª²é¡Œæ›²) ---
        for(let i=1; i < sections.length; i++) {
            const section = sections[i];
            const args = parseArgs(section.tag);
            
            const title = args[0] || `Song_${i}`;
            const wave = args[3] || "";
            
            // é›£æ˜“åº¦ãƒ»ã‚³ãƒ¼ã‚¹æ¨å®š
            let course="Oni", level="10";
            if(args.length >= 8) {
                if(parseFloat(args[6]) > 4) { level=args[6]; course=mapCourse(args[7]); }
                else { course=mapCourse(args[6]); level=args[7]; }
            }

            // â˜…ã“ã“ãŒä¿®æ­£ç‚¹ï¼šå¼·åŠ›ãªã‚«ã‚¦ãƒ³ãƒˆãƒ­ã‚¸ãƒƒã‚¯â˜…
            const needed = count79_Force(section.lines);
            let myBalloons = [];

            if(needed > 0) {
                for(let k=0; k<needed; k++) {
                    if(balloonCursor < globalBalloonPool.length) {
                        myBalloons.push(globalBalloonPool[balloonCursor]);
                        balloonCursor++;
                    } else {
                        myBalloons.push(5); // ä¸è¶³æ™‚ã¯5
                        log(`[${title}] ä¸è¶³ç™ºç”Ÿ: å®šç¾©æ•°ã‚’è¶…ãˆãŸãŸã‚5ã‚’è£œå¡«`, 'err');
                    }
                }
                log(`[${title}] æ¤œå‡º:<span class="log-num">${needed}å€‹</span> â†’ å‰²å½“:[${myBalloons.join(',')}]`, 'head');
            } else {
                // neededãŒ0ã®å ´åˆ
                log(`[${title}] é¢¨èˆ¹ãªã— (0å€‹)`, 'log-zero');
            }

            // å‡ºåŠ›ç”¨ãƒ‡ãƒ¼ã‚¿ä½œæˆ
            let outLines = [];
            outLines.push(`TITLE:${title}`);
            if(args[1]) outLines.push(`SUBTITLE:${args[1]}`);
            outLines.push(`BPM:${currentBpm}`);
            outLines.push(`WAVE:${wave}`);
            outLines.push(`OFFSET:0`);
            outLines.push(`GENRE:${args[2]||""}`);
            outLines.push(`COURSE:${course}`);
            outLines.push(`LEVEL:${level}`);
            
            // â˜… BALLOONè¡Œã®æ›¸ãè¾¼ã¿ â˜…
            // ç©ºã§ã‚‚ BALLOON: ã¨æ›¸ãã‹ã€æ•°å€¤ã‚’å…¥ã‚Œã‚‹
            outLines.push(`BALLOON:${myBalloons.join(',')}`);

            outLines.push(`SCOREINIT:${args[4]||""}`);
            outLines.push(`SCOREDIFF:${args[5]||""}`);
            outLines.push(`SCOREMODE:2`);
            outLines.push('');

            // è­œé¢æœ¬æ–‡
            section.lines.forEach(l => {
                let t = l.trim().toUpperCase();
                // EXAMãªã©ã¯é™¤å»ã€BPMCHANGEã¯è¿½è·¡
                if(!t.startsWith('EXAM') && !t.startsWith('#LEVELHOLD')) {
                    outLines.push(l);
                }
                if(t.startsWith('#BPMCHANGE')) {
                    let p = l.split(/\s+/);
                    if(p[1]) currentBpm = parseFloat(p[1]);
                }
            });

            // ZIPã¸
            const safeTitle = title.replace(/[\\/:*?"<>|]/g, "_");
            const fName = `${i}_${safeTitle}`;
            const folder = zip.folder(fName);
            const suffix = (course==="Edit"||course==="4") ? "_Ura" : "";
            
            folder.file(`${safeTitle}${suffix}.tja`, outLines.join('\n'));

            // éŸ³æºã‚³ãƒ”ãƒ¼
            if(wave) {
                const wName = wave.split(/[/\\]/).pop(); // ãƒ‘ã‚¹é™¤å»
                if(fileMap.has(wName)) {
                    folder.file(wName, fileMap.get(wName));
                }
            }
            processedCount++;
        }

        if(processedCount > 0) {
            const blob = await zip.generateAsync({type:"blob"});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = targetFile.name.replace(/\.tja$/i, '') + "_split.zip";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            log("ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†", 'head');
        } else {
            log("å‡ºåŠ›å¯¾è±¡ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚", 'err');
        }
    }

    // â˜…æœ€å¼·ã®ã‚«ã‚¦ãƒ³ãƒˆé–¢æ•°â˜…
    // #START/#ENDã«é–¢ä¿‚ãªãã€ãƒ˜ãƒƒãƒ€ã¨å‘½ä»¤ä»¥å¤–ã¯å…¨ã¦éŸ³ç¬¦ã¨ã¿ãªã—ã¦ã€Œ7ã€ã¨ã€Œ9ã€ã‚’æ•°ãˆã‚‹
    function count79_Force(lines) {
        let count = 0;
        
        for(let line of lines) {
            let trim = line.trim();
            if(!trim) continue;

            // 1. ã‚³ãƒ¡ãƒ³ãƒˆ(//)ã‚ˆã‚Šå·¦å´ã ã‘ã‚’æœ‰åŠ¹ã«ã™ã‚‹
            let code = trim.split('//')[0].trim();
            if(!code) continue;

            // 2. ãƒ˜ãƒƒãƒ€è¡Œ (TITLE: xxx) ã¯é™¤å¤–
            // â€»ãƒ•ã‚¡ã‚¤ãƒ«åã« : ãŒå«ã¾ã‚Œã‚‹å ´åˆãªã©ã¯èª¤çˆ†ã®å¯èƒ½æ€§ã‚ã‚‹ãŒã€
            //   é€šå¸¸è¡Œé ­ã®å‘½ä»¤ã¯å¤§æ–‡å­—ãªã®ã§ã€ç°¡æ˜“åˆ¤å®šã¨ã—ã¦ã€Œ:ã€ã‚’å«ã‚€è¡Œã¯ã‚¹ã‚­ãƒƒãƒ—
            if(code.indexOf(':') !== -1) continue;

            // 3. å‘½ä»¤ (#BPMCHANGE ãªã©) ã¯é™¤å¤–
            if(code.startsWith('#')) continue;

            // 4. ã“ã“ã¾ã§æ¥ãŸã‚‰éŸ³ç¬¦è¡Œã®å¯èƒ½æ€§ãŒé«˜ã„
            // 7 ã¨ 9 ã‚’æ•°ãˆã‚‹
            for(let char of code) {
                if(char === '7' || char === '9') {
                    count++;
                }
            }
        }
        return count;
    }

    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    function readFile(f, enc) {
        return new Promise((r, rej) => {
            const rd = new FileReader();
            rd.onload = e => r(e.target.result);
            rd.onerror = rej;
            rd.readAsText(f, enc);
        });
    }
    function parseArgs(tag) { return tag.replace(/^#NEXTSONG\s+/i,'').split(',').map(s=>s.trim()); }
    function mapCourse(id) { const m=["Easy","Normal","Hard","Oni","Edit"]; return m[parseInt(id)]||"Oni"; }

</script>
</body>
</html>
