<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TJA Decomposition Tool (Pro)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chardetng/0.1.0/chardetng.min.js"></script>
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; color: #333; background-color: #f4f6f8; line-height: 1.6; }
        .container { background-color: white; padding: 2.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { color: #2d3748; margin-bottom: 0.5rem; text-align: center; }
        p.desc { text-align: center; color: #718096; margin-bottom: 2rem; font-size: 0.95rem; }
        
        .upload-area { 
            padding: 2rem; border: 2px dashed #cbd5e0; border-radius: 8px; background-color: #f8fafc; 
            text-align: center; transition: all 0.2s;
        }
        .upload-area:hover { border-color: #4299e1; background-color: #ebf8ff; }
        
        input[type="file"] { display: none; }
        .custom-file-upload {
            display: inline-block; padding: 12px 24px; cursor: pointer;
            background-color: #4a5568; color: white; border-radius: 6px; font-weight: bold;
            transition: background 0.2s;
        }
        .custom-file-upload:hover { background-color: #2d3748; }

        #fileNameDisplay { margin: 1rem 0; font-weight: bold; color: #3182ce; min-height: 1.5em; }

        #processBtn {
            background-color: #3182ce; color: white; border: none; padding: 14px 40px; 
            font-size: 1.1rem; font-weight: bold; border-radius: 6px; cursor: pointer; 
            transition: background-color 0.2s; display: none; margin: 10px auto;
        }
        #processBtn:hover { background-color: #2b6cb0; }

        #logArea {
            margin-top: 2rem; padding: 1rem; background-color: #2d3748; color: #a0aec0;
            border-radius: 6px; font-family: monospace; font-size: 0.85rem;
            max-height: 300px; overflow-y: auto; text-align: left; display: none;
        }
        .log-info { color: #63b3ed; }
        .log-success { color: #68d391; }
        .log-warn { color: #f6e05e; }
        .log-error { color: #fc8181; }

        .footer { margin-top: 2rem; font-size: 0.8rem; color: #a0aec0; text-align: center; }
    </style>
</head>
<body>

<div class="container">
    <h1>TJA Decomposition Tool</h1>
    <p class="desc">æ®µä½TJAã® <code>#NEXTSONG</code> ã‚’è§£æã—ã€ãƒ˜ãƒƒãƒ€ã¨é¢¨èˆ¹ã‚’è‡ªå‹•ç”Ÿæˆã—ã¦åˆ†å‰²ã—ã¾ã™ã€‚</p>
    
    <div class="upload-area">
        <label for="fileInput" class="custom-file-upload">ğŸ“‚ TJAãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</label>
        <input type="file" id="fileInput">
        <div id="fileNameDisplay">ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
        <button id="processBtn">åˆ†è§£ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
    </div>

    <div id="logArea"></div>
</div>

<div class="footer">Powered by GitHub Pages | TJA-Decomposition-tool</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const fileNameDisplay = document.getElementById('fileNameDisplay');
    const processBtn = document.getElementById('processBtn');
    const logArea = document.getElementById('logArea');
    let selectedFile = null;

    // ãƒ­ã‚®ãƒ³ã‚°ç”¨é–¢æ•°
    function log(msg, type = 'info') {
        logArea.style.display = 'block';
        const div = document.createElement('div');
        div.className = `log-${type}`;
        div.textContent = `> ${msg}`;
        logArea.appendChild(div);
        logArea.scrollTop = logArea.scrollHeight;
    }

    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            selectedFile = e.target.files[0];
            fileNameDisplay.textContent = selectedFile.name;
            processBtn.style.display = "block";
            logArea.innerHTML = '';
            log("ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¾ã—ãŸã€‚æº–å‚™å®Œäº†ã€‚", 'info');
        }
    });

    processBtn.addEventListener('click', async () => {
        if (!selectedFile) return;
        processBtn.disabled = true;
        log("å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™...", 'info');

        try {
            // æ–‡å­—ã‚³ãƒ¼ãƒ‰ã¯Shift-JISå„ªå…ˆã§èª­ã¿è¾¼ã‚€
            let text = await readFileAsText(selectedFile, 'shift-jis');
            
            // æ˜ã‚‰ã‹ã«æ–‡å­—åŒ–ã‘ã—ã¦ã„ã‚‹(TITLEã‚¿ã‚°ãŒè¦‹ã¤ã‹ã‚‰ãªã„)å ´åˆã¯UTF-8ã§å†è©¦è¡Œ
            if (!text.includes('TITLE:') && !text.includes('title:')) {
                log("Shift-JISã§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚UTF-8ã§å†è©¦è¡Œã—ã¾ã™ã€‚", 'warn');
                text = await readFileAsText(selectedFile, 'utf-8');
            }

            const lines = text.split(/\r?\n/);
            const zip = new JSZip();

            // è§£æç”¨å¤‰æ•°
            let songs = [];
            let currentSong = { lines: [], header: {} };
            let globalHeader = { balloon: [] }; // æ®µä½å…¨ä½“ã®é¢¨èˆ¹ãƒªã‚¹ãƒˆ
            let isGlobalHeader = true; // æœ€åˆã®æ›²ãŒå§‹ã¾ã‚‹ã¾ã§ã¯å…±é€šãƒ˜ãƒƒãƒ€æ‰±ã„
            let balloonIndex = 0; // é¢¨èˆ¹ã‚’ã©ã“ã¾ã§é…ã£ãŸã‹ã®ã‚«ãƒ¼ã‚½ãƒ«

            // --- 1. ã¾ãšå…¨è¡Œã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦æ›²ã”ã¨ã«ãƒ–ãƒ­ãƒƒã‚¯åˆ†ã‘ã™ã‚‹ ---
            
            // å…±é€šãƒ˜ãƒƒãƒ€ã®è§£æï¼ˆBALLOONãªã©ã‚’å–å¾—ï¼‰
            for (let line of lines) {
                // BOMå‰Šé™¤
                if (line.charCodeAt(0) === 0xFEFF) line = line.substr(1);
                const trimLine = line.trim();

                // BALLOONè§£æ (ä¾‹: BALLOON: 10,20,30)
                if (isGlobalHeader && trimLine.toUpperCase().startsWith('BALLOON:')) {
                    const val = trimLine.substring(8).trim();
                    if (val) {
                        // å…¨è§’ã‚«ãƒ³ãƒãªã©ã‚‚è€ƒæ…®ã—ã¦åˆ†å‰²
                        globalHeader.balloon = val.split(/[,ã€]/).map(n => parseInt(n.trim()) || 0);
                        log(`å…±é€šé¢¨èˆ¹ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œå‡º: ${globalHeader.balloon.length}å€‹`, 'info');
                    }
                }

                // æ›²ã®åŒºåˆ‡ã‚Šæ¤œçŸ¥
                // #NEXTSONG ã¾ãŸã¯ (2æ›²ç›®ä»¥é™ã®) TITLE
                const isNextSong = trimLine.toUpperCase().startsWith('#NEXTSONG');
                
                // æœ€åˆã®æ›²ã®é–‹å§‹æ¤œçŸ¥ï¼ˆ#STARTï¼‰
                if (isGlobalHeader && trimLine.toUpperCase().startsWith('#START')) {
                    isGlobalHeader = false;
                    // 1æ›²ç›®ã®é–‹å§‹ã€‚ã“ã“ã¾ã§ã®ãƒ˜ãƒƒãƒ€è¡Œã¯ currentSong.lines ã«å…¥ã£ã¦ã„ã‚‹ã¯ãš
                }

                if (isNextSong) {
                    // ä»Šã¾ã§ã®æ›²ã‚’ç¢ºå®š
                    songs.push(currentSong);
                    // æ¬¡ã®æ›²ã®æº–å‚™
                    currentSong = { lines: [], nextSongTag: trimLine };
                    isGlobalHeader = false;
                } else {
                    // é€šå¸¸è¡Œ
                    currentSong.lines.push(line);
                }
            }
            // æœ€å¾Œã®æ›²ã‚’è¿½åŠ 
            if (currentSong.lines.length > 0) {
                songs.push(currentSong);
            }

            log(`åˆè¨ˆ ${songs.length} æ›²ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚å¤‰æ›ã‚’é–‹å§‹ã—ã¾ã™ã€‚`, 'info');


            // --- 2. å„æ›²ãƒ‡ãƒ¼ã‚¿ã‚’åŠ å·¥ã—ã¦å‡ºåŠ› ---
            
            let currentBpm = 0; // BPMè¿½è·¡ç”¨

            for (let i = 0; i < songs.length; i++) {
                const song = songs[i];
                let outputLines = [];
                let songTitle = `Song_${i+1}`;
                let songWave = "";
                
                // --- ãƒ˜ãƒƒãƒ€ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ ---
                
                if (i === 0) {
                    // 1æ›²ç›®: å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ˜ãƒƒãƒ€ã‚’ãã®ã¾ã¾ä½¿ã†ãŒã€ä½™è¨ˆãªCOURSEãªã©ã¯æ•´ç†ã—ã¦ã‚‚ã„ã„
                    // ä»Šå›ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ã€ãƒãƒƒãƒ•ã‚¡ã•ã‚ŒãŸè¡Œã‚’ãã®ã¾ã¾ä½¿ã†ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ‰‹ç›´ã—å‰æï¼‰
                    // ãŸã ã—ã€BPMã ã‘ã¯å–å¾—ã—ã¦ãŠããŸã„
                    song.lines.forEach(l => {
                        if (l.toUpperCase().startsWith('BPM:')) currentBpm = parseFloat(l.split(':')[1]);
                        if (l.toUpperCase().startsWith('TITLE:')) songTitle = l.split(':')[1].trim();
                        if (l.toUpperCase().startsWith('WAVE:')) songWave = l.split(':')[1].trim();
                    });
                    
                    // 1æ›²ç›®ã¯ãã®ã¾ã¾å‡ºåŠ›è¡Œã¨ã™ã‚‹ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé©ç”¨ã¯é›£ã—ã„ã®ã§ï¼‰
                    outputLines = [...song.lines];
                    
                    // ãŸã ã—æœ«å°¾ã®ä½™è¨ˆãªç©ºè¡Œã‚„ã‚³ãƒãƒ³ãƒ‰ã¯æ¶ˆã™ã¹ãã‹ã‚‚ã ãŒã€å®‰å…¨ã®ãŸã‚ãã®ã¾ã¾

                } else {
                    // 2æ›²ç›®ä»¥é™: #NEXTSONGã‚¿ã‚°ã‹ã‚‰æƒ…å ±ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«ã¯ã‚ã‚‹
                    
                    // #NEXTSONG Title, Sub, Genre, Wave, ScoreInit, ScoreDiff
                    const args = parseNextSong(song.nextSongTag);
                    
                    songTitle = args[0] || `Song_${i+1}`;
                    const subTitle = args[1] || "";
                    const genre = args[2] || "";
                    songWave = args[3] || "";
                    const scoreInit = args[4] || "";
                    const scoreDiff = args[5] || "";
                    
                    // BPMã‚’æ¢ã™ï¼ˆå‰ã®æ›²ã®çµ‚ã‚ã‚Šã‹ã€ã“ã®æ›²ã®å†’é ­ã«ã‚ã‚‹ #BPMCHANGE ã‚’å„ªå…ˆï¼‰
                    let myBpm = currentBpm;
                    const bpmChangeLine = song.lines.find(l => l.trim().toUpperCase().startsWith('#BPMCHANGE'));
                    if (bpmChangeLine) {
                        const parts = bpmChangeLine.trim().split(/\s+/);
                        if (parts[1]) myBpm = parseFloat(parts[1]);
                    }

                    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”Ÿæˆ
                    outputLines.push(`TITLE:${songTitle}`);
                    outputLines.push(`SUBTITLE:${subTitle}`);
                    outputLines.push(`BPM:${myBpm}`); // è¿½è·¡ã—ãŸBPM
                    outputLines.push(`WAVE:${songWave}`);
                    outputLines.push(`OFFSET:`); // WAVEä¾å­˜ã®ãŸã‚ç©ºæ¬„
                    outputLines.push(`SONGVOL:100`);
                    outputLines.push(`SEVOL:100`);
                    outputLines.push(`SCOREMODE:2`);
                    outputLines.push(`GENRE:${genre}`);
                    outputLines.push(`DEMOSTART:`);
                    outputLines.push(``);
                    outputLines.push(`COURSE:Oni`); // æ®µä½ãªã®ã§åŸºæœ¬Oni
                    outputLines.push(`LEVEL:10`);   // ä»®ç½®ã
                    
                    // é¢¨èˆ¹ã®è§£æã¨å‰²ã‚Šå½“ã¦
                    const balloonCount = countBalloons(song.lines);
                    if (balloonCount > 0) {
                        const myBalloons = globalHeader.balloon.slice(balloonIndex, balloonIndex + balloonCount);
                        outputLines.push(`BALLOON:${myBalloons.join(',')}`);
                        balloonIndex += balloonCount;
                        log(`[${songTitle}] é¢¨èˆ¹ã‚’ ${balloonCount} å€‹å‰²ã‚Šå½“ã¦ã¾ã—ãŸ (${myBalloons.join(',')})`, 'info');
                    } else {
                        outputLines.push(`BALLOON:`);
                    }

                    outputLines.push(`SCOREINIT:${scoreInit}`);
                    outputLines.push(`SCOREDIFF:${scoreDiff}`);
                    outputLines.push(``); // ç©ºè¡Œ
                    
                    // è­œé¢ãƒ‡ãƒ¼ã‚¿ï¼ˆ#NEXTSONGè¡Œã¯é™¤å»æ¸ˆã¿ãªã®ã§ã€ä¸­èº«ã ã‘ï¼‰
                    // ãŸã ã—ã€å†’é ­ã« #BPMCHANGE ç­‰ãŒã‚ã‚‹å ´åˆãŒã‚ã‚‹ã®ã§ãã®ã¾ã¾çµåˆ
                    outputLines = outputLines.concat(song.lines);
                }

                // è­œé¢ãƒ‡ãƒ¼ã‚¿å†…ã®BPMå¤‰æ›´ã‚’è¿½è·¡ã—ã¦ã€æ¬¡ã®æ›²ã®ãŸã‚ã« currentBpm ã‚’æ›´æ–°ã—ã¦ãŠã
                song.lines.forEach(l => {
                    if (l.trim().toUpperCase().startsWith('#BPMCHANGE')) {
                         const parts = l.trim().split(/\s+/);
                         if(parts[1]) currentBpm = parseFloat(parts[1]);
                    }
                });

                // ZIPã«è¿½åŠ 
                const safeTitle = songTitle.replace(/[\\/*?:"<>|]/g, "_") || "Untitled";
                zip.file(`${i+1}_${safeTitle}.tja`, outputLines.join("\n"));
                log(`è¿½åŠ : ${i+1}_${safeTitle}.tja`, 'success');
            }

            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å‡¦ç†
            const content = await zip.generateAsync({type:"blob"});
            const downloadLink = document.createElement("a");
            downloadLink.href = URL.createObjectURL(content);
            const baseName = selectedFile.name.replace(/\.[^/.]+$/, "");
            downloadLink.download = `${baseName}_split.zip`;
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);

            log("å®Œäº†ï¼ ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚", 'success');

        } catch (err) {
            console.error(err);
            log(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${err.message}`, 'error');
        } finally {
            processBtn.disabled = false;
        }
    });

    // ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
    function readFileAsText(file, encoding) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = (e) => reject(e);
            reader.readAsText(file, encoding);
        });
    }

    // #NEXTSONGã®å¼•æ•°ãƒ‘ãƒ¼ã‚¹
    // å½¢å¼: Title, Sub, Genre, Wave, ScoreInit, ScoreDiff
    function parseNextSong(line) {
        // "#NEXTSONG" ã‚’å‰Šé™¤
        const content = line.replace(/^#NEXTSONG\s+/i, '');
        // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã ãŒã€ã‚¿ã‚¤ãƒˆãƒ«ã«ã‚«ãƒ³ãƒãŒå«ã¾ã‚Œã‚‹ã‚±ãƒ¼ã‚¹ã¯ç¨€ã¨ã—ã¦å˜ç´”åˆ†å‰²
        return content.split(',').map(s => s.trim());
    }

    // è­œé¢ãƒ‡ãƒ¼ã‚¿å†…ã®é¢¨èˆ¹éŸ³ç¬¦(7, 9)ã®æ•°ã‚’æ•°ãˆã‚‹
    function countBalloons(lines) {
        let count = 0;
        let isBody = false; // #STARTä»¥é™ã‹ã©ã†ã‹
        for (let line of lines) {
            if (line.trim().toUpperCase().startsWith('#START')) isBody = true;
            if (line.trim().toUpperCase().startsWith('#END')) isBody = false;
            
            if (isBody) {
                // è¡Œã‹ã‚‰æ•°å­—ä»¥å¤–ã‚’é™¤å»ï¼ˆã‚³ãƒãƒ³ãƒ‰ãªã©ã¯ç„¡è¦–ã—ãŸã„ãŒã€ç°¡æ˜“çš„ã«è¡Œã”ã¨è¦‹ã‚‹ï¼‰
                // ãŸã ã—ã‚³ãƒ¡ãƒ³ãƒˆ // ä»¥é™ã¯ç„¡è¦–
                let cleanLine = line.split('//')[0];
                // ã‚³ãƒãƒ³ãƒ‰è¡Œ(#)ã¯ç„¡è¦–
                if (cleanLine.trim().startsWith('#')) continue;
                
                // 7ã¨9ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
                for (let char of cleanLine) {
                    if (char === '7' || char === '9') count++;
                }
            }
        }
        return count;
    }
</script>
</body>
</html>
