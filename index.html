<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="Shift_JIS">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ®µä½tjaåˆ†è§£ãƒ„ãƒ¼ãƒ«</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --bg-color: #f5f5f5;       /* å…¨ä½“ã®èƒŒæ™¯ï¼šè–„ã„ã‚°ãƒ¬ãƒ¼ */
            --card-bg: #ffffff;        /* ã‚«ãƒ¼ãƒ‰èƒŒæ™¯ï¼šç™½ */
            --accent: #555555;         /* ã‚¢ã‚¯ã‚»ãƒ³ãƒˆï¼šæ¿ƒã„ã‚°ãƒ¬ãƒ¼ */
            --text-main: #333333;      /* æ–‡å­—è‰²ï¼šé»’ã«è¿‘ã„ã‚°ãƒ¬ãƒ¼ */
            --text-sub: #666666;       /* ã‚µãƒ–æ–‡å­—è‰² */
            --border-color: #dddddd;   /* æ ç·š */
            --log-bg: #f9f9f9;         /* ãƒ­ã‚°èƒŒæ™¯ */
        }
        body {
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 40px 20px;
        }
        .container {
            width: 100%;
            max-width: 800px;
            background: var(--card-bg);
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
        }
        h1 {
            color: var(--text-main);
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.6rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 20px;
            font-weight: normal;
        }
        .desc {
            margin-bottom: 30px;
            color: var(--text-sub);
            line-height: 1.8;
            font-size: 0.95rem;
            background: #fafafa;
            padding: 20px;
            border-radius: 6px;
        }
        .desc ul {
            margin: 10px 0 0 0;
            padding-left: 20px;
        }
        .upload-box {
            border: 2px dashed #bbbbbb;
            border-radius: 6px;
            padding: 50px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: #ffffff;
            color: var(--text-sub);
        }
        .upload-box:hover {
            border-color: var(--accent);
            background: #fdfdfd;
            color: var(--text-main);
        }
        .upload-box p { margin: 0; font-size: 1.0rem; }
        
        button {
            width: 100%;
            padding: 16px;
            background-color: var(--accent);
            color: #ffffff;
            border: none;
            border-radius: 6px;
            font-size: 1.0rem;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
            opacity: 0.6;
            pointer-events: none;
            margin-top: 30px;
        }
        button.active { opacity: 1; pointer-events: auto; }
        button:hover { background-color: #333333; }
        
        #file-status {
            text-align: center;
            margin-top: 15px;
            font-weight: bold;
            color: var(--text-main);
            min-height: 1.5em;
        }

        #log {
            margin-top: 30px;
            background: var(--log-bg);
            padding: 15px;
            border-radius: 4px;
            height: 300px;
            overflow-y: auto;
            font-family: Consolas, monospace;
            font-size: 0.85rem;
            white-space: pre-wrap;
            border: 1px solid var(--border-color);
            color: #444;
        }
        /* ãƒ­ã‚°ã®è‰²åˆ†ã‘ï¼ˆæ§ãˆã‚ã«ï¼‰ */
        .log-info { color: #444; }
        .log-success { color: #2e7d32; }
        .log-warn { color: #f57f17; }
        .log-err { color: #c62828; }
        .log-fix { color: #6a1b9a; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>æ®µä½tjaåˆ†è§£ãƒ„ãƒ¼ãƒ«</h1>
    <div class="desc">
        æ®µä½é“å ´ã®TJAãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€é€šå¸¸ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã§å†ç”Ÿå¯èƒ½ãªå˜æ›²å½¢å¼ã«å¤‰æ›ãƒ»åˆ†å‰²ã—ã¾ã™ã€‚<br>
        <strong>ä¸»ãªæ©Ÿèƒ½ï¼š</strong>
        <ul>
            <li>TJAãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ†å‰²ã¨éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®è‡ªå‹•åŒæ¢±</li>
            <li>SUBTITLE / WAVEæ¬„ã®è‡ªå‹•åˆ¤åˆ¥ã¨ä¿®æ­£</li>
            <li>DELAYå€¤ã‚’OFFSETã«å¤‰æ›ï¼ˆã‚ºãƒ¬è£œæ­£ï¼‰</li>
            <li>ä¸è¦ãªå‘½ä»¤ï¼ˆEXAM, LEVELHOLDç­‰ï¼‰ã®å‰Šé™¤</li>
            <li>é¢¨èˆ¹é€£æ‰“æ•°ã®å†åˆ†é…</li>
        </ul>
    </div>

    <div class="upload-box" id="dropZone" onclick="document.getElementById('fileInput').click()">
        <p>ğŸ“‚ ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ (ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—å¯)</p>
        <input type="file" id="fileInput" webkitdirectory directory multiple style="display:none">
    </div>
    <div id="file-status"></div>

    <button id="runBtn">å¤‰æ›ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>

    <div id="log">å¾…æ©Ÿä¸­...</div>
</div>

<script>
    // --- å¤‰æ•°å®šç¾© ---
    const fileInput = document.getElementById('fileInput');
    const dropZone = document.getElementById('dropZone');
    const runBtn = document.getElementById('runBtn');
    const logArea = document.getElementById('log');
    const fileStatus = document.getElementById('file-status');

    let targetTjaFile = null;
    let fileMap = new Map();

    // --- ãƒ­ã‚®ãƒ³ã‚°é–¢æ•° ---
    function log(msg, type = 'info') {
        const div = document.createElement('div');
        div.textContent = msg;
        div.className = `log-${type}`;
        logArea.appendChild(div);
        logArea.scrollTop = logArea.scrollHeight;
    }

    // --- ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›å‡¦ç† ---
    fileInput.addEventListener('change', e => handleFiles(e.target.files));
    dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.style.borderColor = '#555'; });
    dropZone.addEventListener('dragleave', e => { e.preventDefault(); dropZone.style.borderColor = '#bbb'; });
    dropZone.addEventListener('drop', e => {
        e.preventDefault();
        dropZone.style.borderColor = '#bbb';
        handleFiles(e.dataTransfer.files);
    });

    function handleFiles(files) {
        fileMap.clear();
        targetTjaFile = null;
        logArea.innerHTML = '';
        fileStatus.textContent = '';
        runBtn.classList.remove('active');

        const fileList = Array.from(files);
        if (fileList.length === 0) return;

        let tjaCount = 0;
        fileList.forEach(f => {
            fileMap.set(f.name, f);
            if (f.name.toLowerCase().endsWith('.tja')) {
                targetTjaFile = f;
                tjaCount++;
            }
        });

        if (targetTjaFile) {
            fileStatus.textContent = `èª­è¾¼: ${targetTjaFile.name}`;
            log(`[æº–å‚™] ã‚¿ãƒ¼ã‚²ãƒƒãƒˆTJA: ${targetTjaFile.name}`, 'info');
            if(tjaCount > 1) log(`[æ³¨æ„] è¤‡æ•°ã®TJAãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚${targetTjaFile.name} ã‚’å‡¦ç†ã—ã¾ã™ã€‚`, 'warn');
            runBtn.classList.add('active');
        } else {
            log('[ã‚¨ãƒ©ãƒ¼] TJAãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'err');
        }
    }

    // --- ãƒ¡ã‚¤ãƒ³å‡¦ç†å®Ÿè¡Œ ---
    runBtn.addEventListener('click', async () => {
        if (!targetTjaFile) return;
        runBtn.textContent = "å‡¦ç†ä¸­...";
        runBtn.classList.remove('active');

        try {
            await processTja();
            runBtn.textContent = "å®Œäº†ï¼";
        } catch (e) {
            console.error(e);
            log(`[è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼] ${e.message}`, 'err');
            runBtn.textContent = "ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ";
        }
        
        setTimeout(() => {
            runBtn.classList.add('active');
            runBtn.textContent = "å¤‰æ›ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰";
        }, 3000);
    });

    // --- TJAè§£æãƒ»å¤‰æ›ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯ ---
    async function processTja() {
        const zip = new JSZip();
        
        // 1. ãƒ•ã‚¡ã‚¤ãƒ«èª­è¾¼
        let text = await readFileContent(targetTjaFile);
        const lines = text.split(/\r?\n/);

        // 2. BALLOONå…¨å–å¾—
        let globalBalloons = [];
        let tempBalloonStr = "";
        lines.forEach(l => {
            if (l.trim().toUpperCase().startsWith('BALLOON:')) {
                tempBalloonStr += l.trim().substring(8) + ",";
            }
        });
        if (tempBalloonStr) {
            globalBalloons = tempBalloonStr.split(/[,ã€\s]+/)
                .map(n => parseInt(n))
                .filter(n => !isNaN(n));
            log(`[å…¨ä½“] é¢¨èˆ¹ãƒ—ãƒ¼ãƒ«: åˆè¨ˆ ${globalBalloons.length} å€‹`, 'info');
        }

        // 3. ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ†å‰²
        let sections = [];
        let buffer = [];
        let nextTag = "";

        // BOMå¯¾ç­–
        if(lines.length > 0 && lines[0].charCodeAt(0) === 0xFEFF) lines[0] = lines[0].substr(1);

        for (let line of lines) {
            if (line.trim().toUpperCase().startsWith('#NEXTSONG')) {
                sections.push({ lines: buffer, tag: nextTag });
                buffer = [];
                nextTag = line.trim();
            } else {
                buffer.push(line);
            }
        }
        sections.push({ lines: buffer, tag: nextTag });

        // 4. å„æ›²ã®å‡¦ç†
        let balloonCursor = 0;
        let currentBpm = 0;

        // Intro (0ç•ªç›®) å‡¦ç†
        if (sections.length > 0) {
            const intro = sections[0];
            intro.lines.forEach(l => {
                if (l.trim().toUpperCase().startsWith('BPM:')) currentBpm = parseFloat(l.split(':')[1]);
            });
            const introUsed = count79(intro.lines);
            if(introUsed > 0) {
                balloonCursor += introUsed;
                log(`[Intro] è¡¨ç´™éƒ¨åˆ†ã§é¢¨èˆ¹ ${introUsed} å€‹ã‚’ã‚¹ã‚­ãƒƒãƒ—`, 'warn');
            }
        }

        // æ›² (1ç•ªç›®ä»¥é™) å‡¦ç†
        for (let i = 1; i < sections.length; i++) {
            const section = sections[i];
            const args = parseNextSongArgs(section.tag);
            
            // #NEXTSONG [æ›²å],[SUBTITLE],[ã‚¸ãƒ£ãƒ³ãƒ«],[éŸ³æº],[åˆé …],[å…¬å·®],[ãƒ¬ãƒ™ãƒ«],[é›£æ˜“åº¦]
            const title = args[0] || `Song_${i}`;
            let subTitle = args[1] || "";     // 2ç•ªç›®: SUBTITLE
            const genre = args[2] || "";      // 3ç•ªç›®: ã‚¸ãƒ£ãƒ³ãƒ«
            const wave = args[3] || "";       // 4ç•ªç›®: éŸ³æºãƒ•ã‚¡ã‚¤ãƒ«
            const scoreInit = args[4] || "";  // 5ç•ªç›®: åˆé …
            const scoreDiff = args[5] || "";  // 6ç•ªç›®: å…¬å·®
            
            if (subTitle === "--") subTitle = "";

            let course = "Oni"; 
            let level = "10";
            if (args.length >= 8) {
                if (parseFloat(args[6]) > 4) { 
                    level = args[6]; 
                    course = mapCourse(args[7]); 
                } else { 
                    course = mapCourse(args[6]); 
                    level = args[7]; 
                }
            } else if(args[6]) {
                 level = args[6];
            }

            // --- é¢¨èˆ¹åˆ†é… ---
            const needed = count79(section.lines);
            let myBalloons = [];
            for(let k=0; k<needed; k++) {
                if(balloonCursor < globalBalloons.length) {
                    myBalloons.push(globalBalloons[balloonCursor]);
                    balloonCursor++;
                } else {
                    myBalloons.push(5);
                    log(`[${title}] é¢¨èˆ¹ä¸è¶³: 5ã‚’è£œå¡«`, 'warn');
                }
            }

            // --- è­œé¢ãƒ‡ãƒ¼ã‚¿ã®ä¿®æ­£ & DELAYè§£æ ---
            let bodyLines = [];
            let totalDelay = 0.0;
            
            section.lines.forEach(l => {
                const t = l.trim().toUpperCase();
                
                // å‰Šé™¤å¯¾è±¡ãƒ•ã‚£ãƒ«ã‚¿
                if (t.startsWith('EXAM')) return;
                if (t.startsWith('#LEVELHOLD')) return;
                if (t.startsWith('#SECTION')) return;
                if (t.startsWith('#START')) return; 
                if (t.startsWith('#END')) return; 
                if (t.startsWith('BALLOON:')) return; 

                // DELAYè§£æ
                if (t.startsWith('#DELAY')) {
                    const val = parseFloat(l.trim().split(/\s+/)[1]);
                    if (!isNaN(val)) {
                        totalDelay += val;
                    }
                    return; // è¡Œè‡ªä½“ã¯å‰Šé™¤
                }
                
                // BPMè¿½è·¡
                if (t.startsWith('#BPMCHANGE')) {
                    const parts = l.trim().split(/\s+/);
                    if (parts[1]) currentBpm = parseFloat(parts[1]);
                }
                
                bodyLines.push(l);
            });

            if (totalDelay !== 0) {
                log(`[${title}] DELAY: ${totalDelay}s -> OFFSETã¸åæ˜ `, 'fix');
            }

            // --- å‡ºåŠ›ç”¨TJAæ§‹ç¯‰ ---
            let outLines = [];
            outLines.push(`TITLE:${title}`);
            if(subTitle) outLines.push(`SUBTITLE:${subTitle}`);
            outLines.push(`BPM:${currentBpm}`);
            outLines.push(`WAVE:${wave}`);
            
            // DELAYã‚’OFFSET(ãƒã‚¤ãƒŠã‚¹)ã«å¤‰æ›
            outLines.push(`OFFSET:${-totalDelay}`);
            
            outLines.push(`GENRE:${genre}`);
            outLines.push(`COURSE:${course}`);
            outLines.push(`LEVEL:${level}`);
            outLines.push(`BALLOON:${myBalloons.join(',')}`);
            outLines.push(`SCOREINIT:${scoreInit}`);
            outLines.push(`SCOREDIFF:${scoreDiff}`);
            outLines.push(`SCOREMODE:2`);
            outLines.push('');
            
            outLines.push('#START');
            outLines = outLines.concat(bodyLines);
            if (outLines[outLines.length-1].trim() !== "") outLines.push("");
            outLines.push('#END');

            // --- ZIPã«è¿½åŠ  ---
            const safeTitle = title.replace(/[\\/:*?"<>|]/g, "_");
            const folderName = `${i}_${safeTitle}`;
            const folder = zip.folder(folderName);
            
            folder.file(`${safeTitle}.tja`, outLines.join('\r\n'));
            
            // éŸ³æºã‚³ãƒ”ãƒ¼
            if (wave) {
                const waveFileName = wave.split(/[/\\]/).pop();
                if (fileMap.has(waveFileName)) {
                    folder.file(waveFileName, fileMap.get(waveFileName));
                } else {
                    log(`[${title}] éŸ³æºãƒ•ã‚¡ã‚¤ãƒ«ãªã—: ${waveFileName}`, 'warn');
                }
            }
        }

        // 5. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        const content = await zip.generateAsync({type:"blob"});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(content);
        link.download = targetTjaFile.name.replace(/\.tja$/i, "") + "_fixed_final.zip";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        log("å…¨å‡¦ç†å®Œäº†ã€‚ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚", 'success');
    }

    // --- è£œåŠ©é–¢æ•° ---
    function count79(lines) {
        let count = 0;
        for (let line of lines) {
            let trim = line.trim();
            if (!trim) continue;
            let code = trim.split('//')[0].trim();
            if (!code) continue;
            if (code.includes(':') || code.startsWith('#')) continue;
            
            for (let char of code) {
                if (char === '7' || char === '9') count++;
            }
        }
        return count;
    }

    function readFileContent(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const buffer = e.target.result;
                const decoderSJIS = new TextDecoder('shift-jis');
                const textSJIS = decoderSJIS.decode(buffer);
                
                if (textSJIS.includes('TITLE:') || textSJIS.includes('#NEXTSONG') || textSJIS.includes('COURSE:')) {
                    resolve(textSJIS);
                } else {
                    const decoderUTF8 = new TextDecoder('utf-8');
                    resolve(decoderUTF8.decode(buffer));
                }
            };
            reader.onerror = reject;
            reader.readAsArrayBuffer(file);
        });
    }

    function parseNextSongArgs(tag) {
        const raw = tag.replace(/^#NEXTSONG\s+/i, '');
        // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§é…åˆ—åŒ–
        return raw.split(',').map(s => s.trim());
    }

    function mapCourse(val) {
        const map = ["Easy", "Normal", "Hard", "Oni", "Edit"];
        const idx = parseInt(val);
        return map[idx] || "Oni";
    }

</script>
</body>
</html>
